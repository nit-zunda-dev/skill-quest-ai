# 実装タスク: routing-seo-ux

---

## 1. パス定数とルート定義の追加

- [x] 1.1 パス定数を定義し、ガードやナビゲーションから参照できるようにする。ランディング・ログイン・Genesis・アプリ（ダッシュボード）・404 の正規形を単一に定める。
  - _Requirements: 1.1, 5.2_

- [x] 1.2 アプリ全体のルートツリーを定義する。公開（/, /login）、Genesis（/genesis, /genesis/:step）、認証必須（/app とその子）、未定義パス用のキャッチオールを含め、一貫してパスベースで URL と画面が対応するようにする。
  - _Requirements: 1.1, 1.5_

---

## 2. 認証ガード RequireAuth の実装

- [x] 2.1 認証必須領域の手前で認証状態を確認し、未認証の場合はログイン URL へリダイレクトする。リダイレクト先には元の行き先を returnUrl として付与する。ローディング中は読み込み表示とする。
  - _Requirements: 1.2, 4.1, 4.4_

- [x] 2.2 returnUrl を同一オリジンかつアプリ内パスのみ許可するように検証し、無効な値は捨てて /app へフォールバックする。
  - _Requirements: 4.1_

---

## 3. Genesis 完了ガード RequireGenesis の実装

- [x] 3.1 認証済みユーザーのうち、Genesis 未完了の場合は Genesis 用 URL へリダイレクトする。完了済みの場合のみ子要素を描画する。ローディング・エラー時は既存方針に合わせて表示する。
  - _Requirements: 1.3, 4.2_

---

## 4. Genesis レイアウトと認証済み・完了済み時の /app リダイレクト

- [x] 4.1 Genesis 用ルートを描画する親レイアウト（またはラッパー）で Genesis 完了状態を参照し、完了済みの場合はダッシュボード URL へリダイレクトする。これにより認証済み・完了済みユーザーが Genesis URL に直接アクセスした場合に /app へ誘導する。
  - _Requirements: 1.4_

---

## 5. ログイン画面ラッパーと returnUrl 適用

- [x] 5.1 ログイン/サインアップを表示するルートの要素となるラッパーを用意し、URL の returnUrl を取得する。認証成功後に returnUrl が有効ならその URL へ、無効または無ければダッシュボード URL へ遷移する。
  - _Requirements: 4.1_

---

## 6. 404 画面の実装 (P)

- [x] 6.1 (P) 未定義パス用の専用 404 画面を作成する。ページタイトルを「見つかりません」と分かる文言に設定し、ランディングやログインへのリンクを置く。
  - _Requirements: 5.1_

---

## 7. ルート別メタの実装 (P)

- [x] 7.1 (P) ルートごとのタイトル・説明・noindex を設定する仕組みを用意する。公開ルートは一意なタイトルと説明、非公開ルートは汎用タイトルと noindex を設定する。要件 3.3（サーバー/プリレンダー）は本スコープでは行わずクライアントのみで対応する。
  - _Requirements: 3.1, 3.2, 3.4_

---

## 8. エントリと App のリファクタ・ルート統合

- [x] 8.1 アプリのエントリで単一のルーターをマウントし、1.2 で定義したルートツリーを描画する。既存の認証・プロフィール用プロバイダは維持する。
  - _Requirements: 2.1, 2.2_

- [x] 8.2 App を、ルートに応じてランディング・ログイン・Genesis・ダッシュボードのいずれかを描画する責務に縮小する。状態による分岐をルートとガードに委ね、リロードや新タブでも URL と認証・Genesis 状態から正しい画面が復元されるようにする。
  - _Requirements: 2.3_

---

## 9. ダッシュボードを /app 配下に接続

- [x] 9.1 認証済みかつ Genesis 完了後のメイン領域を /app 配下のルートとして接続する。ダッシュボード用レイアウトと Home・クエスト・グリモワール・パートナー・アイテムの子ルートを定義し、既存の AppLayout と各ページを流用する。
  - _Requirements: 1.1, 2.1_

---

## 10. Genesis の URL 同期と完了後の遷移

- [x] 10.1 Genesis の各ステップ（INTRO → QUESTIONS → LOADING → RESULT → SUGGEST）への遷移時に、対応する URL へナビゲートする。ブラウザの戻る・進むでステップが復元されるようにする。
  - _Requirements: 2.1_

- [x] 10.2 Genesis 完了時（「世界へ旅立つ」等）にダッシュボード URL へ遷移する。リロード時もプロフィール取得によりダッシュボードが表示され、Genesis を再実行しないようにする。
  - _Requirements: 4.3_

---

## 11. サインアウト後の /login リダイレクト

- [x] 11.1 サインアウト実行後にログイン/サインアップの URL へ遷移する。セッション解除後は保護ルートにアクセスできないことをガードで保証する。
  - _Requirements: 4.4_

---

## 12. クエリ・ハッシュの正規化

- [x] 12.1 ログイン/サインアップの mode や returnUrl など、クエリ・ハッシュの無効または欠落した値をデフォルトに正規化する。不正値でルーティングが破綻したり回復不能な状態にユーザーが残ったりしないようにする。Genesis の :step の不正値は intro へ正規化する。
  - _Requirements: 5.3_

---

## 13. 各ルートへのメタ適用

- [x] 13.1 ランディング・ログイン・404 および必要に応じて他ルートで、ルート別メタの仕組みを呼び出し、公開ルートでは一意なタイトル・説明・OG を、非公開では汎用タイトルと noindex を設定する。
  - _Requirements: 3.1, 3.2, 3.4_

---

## 14. テスト

- [x] 14.1 認証ガードと Genesis ガードの単体テストを追加する。認証済みのときは子要素が描画され、未認証・Genesis 未完了のときは期待する URL へリダイレクトすることをモックで検証する。
  - _Requirements: 1.2, 1.3_

- [x] 14.2 未認証で /app にアクセスしたときの /login リダイレクトと returnUrl 付与、ログイン成功後の returnUrl 遷移、Genesis 未完了で /app にアクセスしたときの /genesis リダイレクトを統合テストで検証する。
  - _Requirements: 4.1, 4.2_

- [x] 14.3 ランディング → ログイン → Genesis 完了 → ダッシュボードの一連の遷移で URL が変わり、リロードで同じ画面が復元されること、および未定義パスで 404 が表示されることを E2E または手動で検証する。
  - _Requirements: 2.1, 2.2, 2.3, 5.1_
