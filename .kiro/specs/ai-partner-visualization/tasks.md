# Implementation Plan: ai-partner-visualization

## 1. パートナー画像の参照パスと型・定数を用意する (P)

- [x] 1.1 バリアント（default / male）と表情（立ち絵・各表情）の型、ベースパスとファイル名定数、およびパスを組み立てる関数を実装する。不正なバリアントが渡された場合は default にフォールバックする。
  - 立ち絵は standing、表情は expression-default / smile / cheer / happy / worried のファイル名規則に従う。
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 6.3_

## 2. 文脈から表情へマッピングするルールを一元化する (P)

- [ ] 2.1 待機・送信中・達成・未達フォローなどの文脈（UI 状態）から表示用表情を返す関数または定数を lib または hooks に定義する。パートナーページとウィジェットの両方で同じルールを参照する。
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

## 3. パートナー画像の表示と読み込み失敗時のフォールバックを行う UI を追加する

- [ ] 3.1 バリアントと表情に応じた画像を表示するコンポーネントを実装する。縦長のアスペクト比（例: 3:4）とレイアウト用のクラス指定を可能にし、透過画像が既存 UI と調和するようにする。
  - _Requirements: 2.1, 2.2, 2.3, 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 3.2 画像読み込み失敗時はクラッシュせず、責めない・応援するトーンのフォールバック表示（アイコンまたは短い文言）に切り替える。
  - _Requirements: 6.1, 6.2_

## 4. バリアントの取得・永続化用の Context と Provider を追加し App に配置する (P)

- [ ] 4.1 state と localStorage を同期する Provider を実装し、フックで現在のバリアントと setVariant を返す。未設定時は default。localStorage が利用できない環境ではメモリ上の default のみで動作させる。
  - _Requirements: 5.1, 5.2, 5.4_

- [ ] 4.2 App ルート付近に Provider を配置し、パートナーページとウィジェットの両方で同一バリアントを参照し、片方で変更すると他方も即時反映されるようにする。
  - _Requirements: 5.4_

## 5. パートナーページにパートナー画像を表示し、バリアントと文脈に応じた表情を渡す

- [ ] 5.1 バリアント取得と文脈→表情マッピングを使い、パートナー画像をチャット領域の上または横に配置する。「拠点で待ってくれる相棒」の世界観とペルソナに沿ったレイアウト・余白・サイズにする。
  - _Requirements: 2.1, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.4_

## 6. パートナーウィジェットにパートナー画像を表示し、バリアントと文脈に応じた表情を渡す (P)

- [ ] 6.1 パートナーページと同様にバリアントと文脈→表情マッピングを使い、ウィジェット内にパートナー画像を配置する。ウィジェットの小さい領域に収まるようサイズを調整する。
  - _Requirements: 2.1, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.4_

## 7. テストを追加する

- [ ] 7.1 パス組み立ての戻り値がバリアント・表情に応じて正しいこと、および不正バリアント時に default にフォールバックすることを単体テストで検証する。
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 6.3_

- [ ] 7.2 バリアントの初期読み込み・setVariant 時の保存・localStorage 利用不可時にデフォルトが返ることを単体テストで検証する。
  - _Requirements: 5.1, 5.2, 5.4_

- [ ] 7.3 パートナー画像コンポーネントについて、渡したバリアント・表情で正しい src が設定されること、onError 時にフォールバックが表示されること、alt や className が適用されることをテストする。
  - _Requirements: 2.1, 2.2, 2.3, 6.1, 6.2_

- [ ] 7.4 パートナーページとウィジェットにパートナー画像が表示され、バリアントが共有・反映されることを結合テストで検証する（必要に応じてモックを使用）。
  - _Requirements: 2.1, 5.4_

- [ ]* 7.5 E2E または手動で、画像表示と読み込み失敗時のフォールバック表示、既存パートナーチャットフローが壊れていないことを確認する。
  - _Requirements: 2.1, 6.1_
