# Implementation Tasks: quest-auto-generation

## 1. 共有型・スキーマとプロフィールへの目標永続化

- [x] 1.1 キャラクター用プロフィールに目標（goal）を追加し、Genesis でキャラ生成後にリクエスト body の目標をプロフィールにマージして保存する。既存ユーザーは goal が無くてもよいためオプショナルとする。
  - _Requirements: 1.1, 4.1_

- [x] 1.2 (P) 提案リクエスト・提案 1 件・クエスト一括作成用の型と Zod スキーマを共有パッケージに追加する。既存クエスト形式と整合するようにする。
  - _Requirements: 2.2, 3.2_

---

## 2. 目標からタスクリストを生成する AI と API

- [x] 2.1 目標とオプションのジャンルを受け取り、3〜7 件の実行可能タスクを返す AI 生成処理を追加する。出力を既存クエスト形式に正規化し、不正な要素はスキップまたはデフォルトで補正する。失敗時は空配列またはエラーとする。
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 2.2 認証付きの提案取得エンドポイントを追加する。目標の長さ・内容の検証とサニタイズを行い、不正時は 400、AI 失敗時は 500/502 とメッセージを返す。
  - _Requirements: 2.1, 2.4, 5.1, 5.2_

---

## 3. 目標更新の 1 日 2 回制限とクエストリセット

- [ ] 3.1 (P) 日次 AI 利用テーブルに目標更新回数列を追加するマイグレーションと、その日の更新回数の取得・インクリメントを行う利用ロジックを追加する。
  - _Requirements: 5.3_

- [ ] 3.2 (P) 当該ユーザーのクエストを一括削除する処理を追加する。
  - _Requirements: 1.2, 5.3_

- [ ] 3.3 目標更新用エンドポイントを追加する。1 日 2 回を超えている場合は 429 を返し、そうでない場合はプロフィールの目標更新・クエスト全削除・更新回数インクリメントを D1 トランザクション内で実行する（いずれか失敗時は 500 でリトライ可能にする）。
  - _Requirements: 1.1, 1.2, 5.3_

---

## 4. クエスト一括登録 API

- [ ] 4.1 複数クエストを一括作成するバッチエンドポイントを追加する。各要素を既存クエスト作成スキーマで検証し、件数上限を設ける。作成されたクエスト一覧を返す。
  - _Requirements: 3.2_

---

## 5. フロント: 提案・目標更新・一括登録の API 呼び出し

- [ ] 5.1 (P) 提案取得・目標更新・クエスト一括作成を呼び出す API クライアント関数を追加する。
  - _Requirements: 2.1, 4.2_

- [ ] 5.2 提案取得と採用時の一括登録を行うフックを追加する。ローディング・エラー状態を扱う。
  - _Requirements: 2.1, 4.2_

---

## 6. Genesis 直後の提案ステップ

- [ ] 6.1 Genesis フローで RESULT の次に表示する提案ステップを挿入する。キャラ生成完了後にそのステップへ進み、完了後にダッシュボードへ遷移する。
  - _Requirements: 1.2, 4.1_

- [ ] 6.2 提案ステップで、保存済みプロフィールの目標を使って提案を取得し、一覧表示する。goal が無い場合は簡易入力フォームを表示する。生成中はローディングを表示する。採用時は一括登録してクエスト一覧を更新し、却下時は何も登録せず、いずれも完了後にダッシュボードへ進む。
  - _Requirements: 1.2, 3.1, 3.2, 3.3, 4.2, 4.3_

---

## 7. ダッシュボードの目標更新 UI と提案モーダル

- [ ] 7.1 ダッシュボード上で現在の目標を表示し、編集・確定できる UI を追加する。確定時に目標更新 API を呼び、1 日 2 回超過時は 429 を受け取り案内メッセージを表示する。成功時は提案モーダルを開く。
  - _Requirements: 1.2, 5.3_

- [ ] 7.2 提案タスク一覧を表示し、採用・却下を選択できるモーダルを追加する。採用時は一括登録し、閉じた後に Quest Board を更新する。AI 失敗・タイムアウト時は再試行または後で試す案内を表示する。
  - _Requirements: 3.1, 3.2, 3.3, 5.1_

---

## 8. 空状態での案内（オプション）

- [ ] 8.1 クエストが 1 件もない状態で Quest Board を表示するとき、目標からタスクを生成する案内または CTA を表示する。
  - _Requirements: 1.3_

---

## 9. テスト

- [ ] 9.1 目標からタスクを生成する AI 処理のプロンプト・パース、目標更新の 1 日 2 回チェックとクエスト削除のモック、バッチ作成スキーマの検証を行う単体テストを追加する。
  - _Requirements: 2.1, 2.2, 2.4, 5.3, 3.2_

- [ ] 9.2 提案取得・目標更新・クエスト一括作成の各エンドポイントについて、認証・バリデーション・スタブ AI または DB を使った統合テストを追加する。
  - _Requirements: 2.1, 2.4, 5.1, 5.2, 5.3, 3.2_

- [ ]* 9.3 Genesis 完了→提案表示→採用→ダッシュボードでクエスト表示、ダッシュボードで目標変更→提案→採用でクエスト差し替え、目標を 3 回変更して 3 回目に 429 となる流れを E2E または UI で検証する（受入基準に基づく検証。MVP 後でも可）。
  - _Requirements: 4.3, 5.3_
