# Implementation Plan: infra-stability-cost

## Task Format

- **Major task**: 1, 2, 3 …（要約のみのコンテナの場合は詳細は子タスクに記載）
- **Sub-task**: 1.1, 1.2 …（1タスクあたり 1–3 時間目安）
- **(P)**: 他タスクとデータ・ファイルの競合がなく、並行実行可能なものに付与

---

- [ ] 1. Neurons 概算の記録基盤とスキーマ拡張
- [x] 1.1 (P) 日次 AI 利用テーブルに Neurons 概算用カラムを追加するマイグレーションを作成し、スキーマ定義を更新する
  - 既存 PK・FK は変更しない。デフォルト 0 の整数カラムを追加する
  - _Requirements: 1.1, 1.2_
- [x] 1.2 各 AI 操作（キャラ生成・ナラティブ・パートナー・チャット・グリモワール・目標更新）の記録時に、操作種別ごとの係数で Neurons 概算を加算する。実 AI を実行したリクエストでのみ記録し、スタブ応答時は加算しない
  - _Requirements: 1.1, 1.2_
- [x] 1.3 指定日（UTC 日付）のグローバル Neurons 概算合計を取得する機能を追加し、閾値判定から利用できるようにする
  - _Requirements: 1.2, 2.4_
- [x] 1.4 係数値を定数として定義し、Cloudflare 課金単位（Neurons）との対応をドキュメントに記載する
  - _Requirements: 1.4_

---

- [ ] 2. 無料枠到達時のスタブフォールバック
- [x] 2.1 環境変数で閾値（および必要に応じて日次上限）を設定できるように型定義を拡張する。未設定時はフォールバック判定を行わない
  - _Requirements: 2.4_
- [x] 2.2 AI サービス生成を拡張し、今日の Neurons 概算合計を取得して閾値以上ならスタブを返す分岐を追加する。統合テスト用スタブフラグは従来どおり最優先とする
  - _Requirements: 2.1, 2.3_
- [ ] 2.3 スタブ応答では「AI 利用一時制限中」等、スタブであることが分かるメッセージを返す。閾値超過でスタブを返した場合は Workers AI を呼ばず、当該リクエストでは利用量記録を呼ばない
  - _Requirements: 2.2, 2.3_

---

- [ ] 3. ヘルスチェック API
- [ ] 3.1 (P) 稼働状態を返す GET エンドポイントを追加し、認証なしで 200 と簡易ステータス（JSON）を返す。外形監視が HTTP で叩けるようにする
  - _Requirements: 4.1, 4.2, 4.3_
- [ ] 3.2 (P) オプションで D1 に対して軽いクエリで健全性を確認し、レスポンスに checks.db を含める。失敗時は status は ok のまま db のみ unhealthy とする
  - _Requirements: 4.4_

---

- [ ] 4. 構造化ログと observability 連携
- [ ] 4.1 (P) 機密キーをマスキングし JSON で console に出力する構造化ログ用ヘルパーを追加する。トークン・パスワード・認証ヘッダ等は含めない
  - _Requirements: 5.1, 5.4_
- [ ] 4.2 既存のリクエストログとエラーハンドラから構造化ログを呼び出し、時刻・パス・メソッド・ステータス・所要時間等を記録する
  - _Requirements: 5.1, 5.2_
- [ ] 4.3 wrangler の observability を有効化し、Cloudflare 側でログの取り込みと利用が可能になるようにする
  - _Requirements: 5.3_

---

- [ ] 5. 運用者向け API（認可・集計・日付制限）
- [ ] 5.1 (P) AI 利用量の日次集計（日付範囲最大 90 日）と、登録ユーザー数・アクティブユーザー数（直近 N 日のセッション存在で定義）を取得するサービスを実装する
  - 集計は読み取り専用。日付範囲超過は呼び出し元で 400 にする
  - _Requirements: 1.3, 6.1, 6.2_
- [ ] 5.2 運用者 API 用ルートを追加し、リクエストヘッダの API キーと環境変数を照合して認可する。キー未設定の環境では当該ルートを登録せず、該当パスは 404 とする
  - _Requirements: 6.4_
- [ ] 5.3 利用量集計エンドポイントで from/to を検証し、90 日超過時は 400 を返す。ユーザー数エンドポイントを実装し、認可時のみ集計結果を返す
  - _Requirements: 1.3, 6.1, 6.2, 6.3_

---

- [ ] 6. CORS と機密の明文化
- [ ] 6.1 (P) 本番で許可するオリジンと、機密情報をランタイム（Bindings）に限定する扱いをドキュメントに明記する。環境別の設定方針を含める
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

---

- [ ] 7. 統合とルート接続
- [ ] 7.1 アプリのエントリでヘルスエンドポイントを登録する。OPS_API_KEY が設定されている場合のみ運用者 API ルートを登録する
  - _Requirements: 4.1, 6.4_
- [ ] 7.2 各 AI 呼び出し箇所で AI サービス生成に DB と今日日付取得を渡す。スタブが返った場合は利用量記録（record*）を呼ばない
  - _Requirements: 2.1, 2.3_
- [ ] 7.3 ヘルス 200・D1 健全性、運用者 API の認可成功・401・404、日付範囲超過 400、閾値超過時のスタブ応答、構造化ログ出力を検証する統合テストを追加する
  - _Requirements: 1.3, 2.2, 4.2, 5.1, 6.4_
