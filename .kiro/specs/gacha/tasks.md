# ガチャ機能 実装タスク

## 概要

クエスト完了時のアイテム付与と所持一覧を実現するための実装タスク一覧。設計書（design.md）のコンポーネントと契約に従い、要件 1.1〜5.3 をカバーする。

---

## タスク一覧

- [ ] 1. 共有パッケージにレアリティ・カテゴリ・アイテム・所持表示用の型とスキーマを追加する
- [x] 1.1 (P) レアリティとカテゴリの列挙型を追加し、表示・ソート用の順序と閉集合であることを文書化する
  - 5段階レアリティと7カテゴリを仕様どおり定義する
  - レアリティの大小関係（common 未満 rare 未満 … legend）をコメントまたは定数で明示する
  - _Requirements: 1.1, 1.4, 5.1, 5.2_
- [x] 1.2 (P) アイテムマスタ用の型と所持一覧表示用の型を追加し、画像パス規則を文書化する
  - 一意ID・表示名・カテゴリ・レアリティ・説明（任意）を持つ型を定義する
  - クライアントが一覧表示に必要な項目（アイテムID・取得時刻・名前・カテゴリ・レアリティ）を持つ型を定義する
  - 画像パスを category と id から組み立てる規則（例: /images/items/{category}/{id}.png）をコメントまたは定数で明示する
  - _Requirements: 1.2, 1.3, 4.2_
- [x] 1.3 (P) 所持一覧 API のレスポンス用 Zod スキーマを追加する
  - 確率値やマスタの許容値はコード内コメントで文書化する
  - _Requirements: 5.3_

- [ ] 2. アイテムマスタとユーザー所持用のテーブルを追加し、マイグレーションと初期データ投入を行う
- [x] 2.1 アイテムマスタ用テーブルとユーザー所持履歴用テーブルを Drizzle スキーマに定義する
  - 一意ID・カテゴリ・レアリティ・表示名・説明・ドロップ有効フラグを持つマスタテーブルを追加する
  - ユーザーID・アイテムID・クエストID・取得時刻を持つ所持履歴テーブルを追加する
  - 同一ユーザー・同一クエストで高々1件になるようユニーク制約を設ける
  - クエスト削除時は所持履歴のクエストIDを NULL にする方針で参照を定義する
  - _Requirements: 1.1, 1.2, 1.4, 3.2, 4.1, 4.4_
- [x] 2.2 上記テーブル用のマイグレーション SQL を作成し、既存のマイグレーション手順で適用できるようにする
  - 一覧取得のためのインデックス（ユーザーID・取得時刻）を検討する
  - _Requirements: 1.1, 4.1_
- [x] 2.3 初期アイテムマスタを投入するデータをマイグレーションまたはシードで用意し、本番未投入のままデプロイしないことをタスクで担保する
  - 仕様のカテゴリ・レアリティに沿った最低限のアイテムを投入する
  - 抽選対象とするアイテムにはドロップ有効フラグを立てる
  - _Requirements: 2.3, 2.4_

- [ ] 3. ガチャ抽選とクエスト完了時付与のサービスを実装する
- [x] 3.1 レアリティに基づく確率で1個だけ抽選する処理を実装する
  - マスタに存在しドロップ有効なアイテムのみを対象とする
  - 確率の相対順序（common より rare が低い、など）を保つ定数で確率を定義する
  - マスタが空またはドロップ対象が0件の場合はアイテムなしとして正常終了する（例外を投げない）
  - _Requirements: 2.1, 2.2, 2.3, 2.4_
- [x] 3.2 指定ユーザー・クエストに対して高々1回だけ付与する冪等な付与処理を実装する
  - 当該クエストで既に付与済みなら何もせず、未付与なら抽選して1件記録する
  - 付与時にユーザー・アイテム・取得時刻を所持履歴に記録する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 4. 認証ユーザー本人の所持一覧を返す API を追加する
- [x] 4.1 GET /api/items で認証済みユーザーの所持アイテム一覧を取得時刻の降順で返す
  - 認証必須とし、本人以外の所持は返さない
  - 各件にアイテムID・取得時刻・表示用の名前・カテゴリ・レアリティを含める
  - 同一アイテムを複数回取得している場合は複数行として返す
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 5. クエスト完了が確定したタイミングで付与処理を呼び出すよう既存ルートを拡張する
- [ ] 5.1 クエストを完了にする PATCH（完了専用とステータス更新）の成功後に、付与処理を1回呼び出す
  - 認証とクエストのオーナーであることは既存チェックで担保する
  - _Requirements: 3.1, 3.3, 3.4_
- [ ] 5.2 ナラティブ生成完了フローの成功後に、付与処理を1回呼び出す
  - 既存の完了更新の後に呼び出し、認証・オーナーは既存で担保する
  - _Requirements: 3.1, 3.3, 3.4_

- [ ] 6. フロントで所持一覧を取得して表示する
- [ ] 6.1 所持一覧 API を呼び出すクライアント処理を追加し、獲得アイテムページで一覧を表示する
  - 認証ユーザー本人の所持のみ取得する
  - 既存の獲得アイテム用プレースホルダーを、API 取得結果の一覧表示に差し替える
  - 画像はパス規則に従いクライアントで組み立てる（表示は最小限でよい）
  - _Requirements: 4.2_

- [ ] 7. ガチャ・所持一覧の単体テストと統合テストを追加する
- [ ] 7.1 抽選がドロップ有効なアイテムのみから選ばれること、同一クエストで2回付与しないこと、マスタ空で付与なしとなることを単体テストで検証する
  - _Requirements: 2.1, 2.3, 2.4, 3.3_
- [ ] 7.2 PATCH による完了後に所持が1件増えること、ナラティブ完了後も同様に1件増えること、同じクエストで再度完了しても増えないこと、未認証で一覧が 401 となることを統合テストで検証する
  - _Requirements: 3.1, 3.3, 4.1, 4.3_
- [ ]* 7.3 ログインからクエスト完了、獲得アイテム画面で新規取得が表示される流れを E2E で検証する（任意・MVP 後でも可）
  - _Requirements: 4.2_
