# 要件定義書

## 概要

ZAPテストレポート（2026-02-14）で検出されたセキュリティ課題に対応する。対象は Skill-Quest-AI のフロントエンド（localhost:3000 / Vite）およびバックエンドAPI（localhost:8787 / Hono + Cloudflare Workers）。第三者のCDNや外部ドメインに起因するアラートは対象外とする。

### プロジェクト説明（入力）

ZAPテストレポート（2026-02-14）で検出されたセキュリティ対策を実施する。対象は Skill-Quest-AI の localhost:3000（フロントエンド）および localhost:8787（バックエンドAPI）。主な対策項目: (1) CSP・X-Frame-Options・X-Content-Type-Options 等のセキュリティヘッダー追加、(2) 可能な範囲での SRI 導入、(3) CORS・クロスドメイン設定の見直し、(4) 本番環境向けの HSTS・Cookie 属性の検討。第三者のCDNや外部ドメインは対象外。

## 要件

### 1. セキュリティヘッダー（バックエンドAPI）

**目的:** オペレーターとして、バックエンドAPIが適切なセキュリティヘッダーを返すことを期待し、クリックジャッキング・MIME推測・XSS等の攻撃を軽減する。

#### 受入条件

1. バックエンドAPIが任意のHTTPレスポンスを返す場合、バックエンドAPIは `X-Content-Type-Options: nosniff` ヘッダーを含めること。
2. バックエンドAPIが任意のHTTPレスポンスを返す場合、バックエンドAPIは `X-Frame-Options` ヘッダーを `DENY` または `SAMEORIGIN` で含めること。
3. バックエンドAPIがHTMLまたはユーザー向けコンテンツを配信する場合、バックエンドAPIは `Content-Security-Policy`（CSP）ヘッダーまたは report-only を設定すること。

### 2. セキュリティヘッダー（フロントエンド）

**目的:** オペレーターとして、フロントエンドの配信時にセキュリティヘッダーが付与されることを期待し、ZAPで検出されたクリックジャッキング・CSP欠如を解消する。

#### 受入条件

1. フロントエンドが配信される場合（開発環境または本番環境）、フロントエンドサーバーは `X-Frame-Options` ヘッダーを `DENY` または `SAMEORIGIN` で含めること。
2. フロントエンドが配信される場合、フロントエンドサーバーは `X-Content-Type-Options: nosniff` ヘッダーを含めること。
3. 本番環境でフロントエンドが配信される場合、フロントエンドサーバーはアプリケーションのスクリプト・スタイル・リソースソースに適した `Content-Security-Policy`（CSP）ヘッダーを含めること。

### 3. Sub Resource Integrity（SRI）

**目的:** オペレーターとして、同一オリジンから読み込むスクリプト・スタイルにSRIを適用することを期待し、改ざんリスクを低減する。

#### 受入条件

1. フロントエンドが同一オリジンからスクリプトまたはスタイルを読み込む場合、フロントエンドは可能な範囲で `integrity` および `crossorigin` 属性を含めること。
2. 外部CDNリソース（例: Tailwind CDN、Google Fonts）を使用する場合、システムはSRI採用の方針を文書化し、バージョン固定かつ整合性ハッシュが利用可能なリソースについてはSRIの設定を提供すること。

### 4. CORS・クロスドメイン設定

**目的:** オペレーターとして、バックエンドAPIのCORS設定が適切に制限されることを期待し、意図しないクロスオリジンアクセスを防ぐ。

#### 受入条件

1. バックエンドAPIがクロスオリジンリクエストを受け取る場合、バックエンドAPIはリクエストの Origin を許可リスト（例: `FRONTEND_URL`、信頼するオリジン）で検証すること。
2. クロスオリジンで資格情報（Cookie）を送信する場合、バックエンドAPIは `Access-Control-Allow-Origin` を `*` ではなく許可する特定オリジンに設定すること。
3. バックエンドAPIは、クライアントに必要以上の機密ヘッダーを露出しないこと（例: セキュリティ上重要なヘッダーを `Access-Control-Expose-Headers` に含めないこと）。

### 5. HSTS・本番環境のトランスポートセキュリティ

**目的:** オペレーターとして、本番環境でHTTPSを強制し、中間者攻撃のリスクを下げる。

#### 受入条件

1. 本番環境でバックエンドAPIがHTTPSで配信される場合、バックエンドAPIは適切な `max-age`（および任意で `includeSubDomains`）を持つ `Strict-Transport-Security`（HSTS）ヘッダーを含めること。
2. 本番環境でフロントエンドがHTTPSで配信される場合、フロントエンドサーバーは `Strict-Transport-Security`（HSTS）ヘッダーを含めること。
3. 開発環境（HTTPのlocalhost）では、ローカルワークフローを損なわないようHSTSを設定しないこと。

### 6. Cookie属性（セッション・認証）

**目的:** オペレーターとして、セッションCookieが適切な属性を持つことを期待し、XSS・CSRFからの露出を最小化する。

#### 受入条件

1. バックエンドがセッションCookieを発行する場合、バックエンドAPIは `HttpOnly` 属性を設定すること。
2. 本番環境でHTTPS経由でアプリケーションが配信される場合、バックエンドAPIはセッションCookieに `Secure` 属性を設定すること。
3. バックエンドがセッションCookieを発行する場合、クロスサイトでのCookie送信が明示的に必要な場合（例: 埋め込みiframe）を除き、バックエンドAPIは `SameSite` 属性を `Lax` または `Strict` に設定すること。

### 7. 検証と追跡

**目的:** 開発チームとして、セキュリティ対策の実施を検証し、再スキャンで確認できるようにする。

#### 受入条件

1. セキュリティヘッダーを実装した場合、HTTPレスポンスヘッダーの検証（例: curl、ブラウザ DevTools、自動テスト）で確認可能であること。
2. ZAP等のスキャンを実行した場合、対象アラート種別（CSP、X-Frame-Options、X-Content-Type-Options、SRI、CORS、HSTS、Cookie属性）の対策状況および例外を文書化すること。
