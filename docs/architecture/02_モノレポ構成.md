# モノレポ構成と開発環境戦略

HonoのRPC機能（`hc<AppType>`）を最大限に活用し、型定義の共有を円滑に行うため、**pnpm workspaces** を用いたモノレポ構成を採用する。これにより、バックエンドの変更が即座にフロントエンドの型エラーとして検知され、堅牢な開発が可能となる。

## ディレクトリ構造

```
skill-quest-ai/
├── package.json          # ルート設定、ワークスペース定義
├── pnpm-workspace.yaml   # packages/, apps/ の包含定義
├── turbo.json            # ビルドパイプラインの定義（Turborepo）
├── tsconfig.json         # ベースとなるTypeScript設定
├── apps/
│   ├── frontend/         # React + Vite + Tailwind (クライアント)
│   │   ├── src/
│   │   │   ├── lib/client.ts   # Hono RPCクライアントの初期化
│   │   │   ├── lib/app-type.ts # AppType の再エクスポート（必要時）
│   │   │   └── ...
│   │   ├── vite.config.ts
│   │   └── package.json
│   └── backend/          # Hono + Cloudflare Workers (サーバー)
│       ├── src/
│       │   ├── index.ts  # エントリーポイント (AppTypeのエクスポート)
│       │   ├── db/       # Drizzleスキーマ定義
│       │   ├── routes/   # 各機能のルート定義 (quests, ai, profile, grimoire)
│       │   └── middleware/
│       ├── wrangler.toml # Cloudflare環境設定
│       └── package.json
└── packages/
    ├── config/           # 共有設定 (ESLint, TypeScript)
    └── shared/           # 共有型定義, Zodスキーマ
        ├── src/
        │   └── index.ts
        └── package.json
```

## 型共有のメカニズム

本アーキテクチャの核となるのが、HonoのRPC機能による型共有である。

### バックエンド側 (`apps/backend/src/index.ts`)

APIのルート定義を行い、その型 `AppType` をエクスポートする。認証は Better Auth のハンドラを `/api/auth/*` にマウントする。

```typescript
import { Hono } from 'hono'
import { questsRouter } from './routes/quests'
import { aiRouter } from './routes/ai'
import { profileRouter } from './routes/profile'
import { grimoireRouter } from './routes/grimoire'

const app = new Hono<{ Bindings: Bindings }>()

app.on(['POST', 'GET'], '/api/auth/*', (c) => { /* Better Auth ハンドラ */ })
app.use('/api/quests/*', authMiddleware)
app.route('/api/quests', questsRouter)
app.route('/api/ai', aiRouter)
app.route('/api/profile', profileRouter)
app.route('/api/grimoire', grimoireRouter)

export type AppType = typeof app
export default app
```

### フロントエンド側 (`apps/frontend/src/lib/client.ts`)

バックエンドから型のみをインポートし、クライアントを生成する。この際、ビルド時にバックエンドのコードが含まれないよう、TypeScriptの `import type` を使用する。

```typescript
import { hc } from 'hono/client'
import type { AppType } from '@skill-quest/backend'

const apiUrl = import.meta.env?.VITE_API_URL || 'http://localhost:8787'
export const client = hc<AppType>(apiUrl, { init: { credentials: 'include' } })
```

この設定により、フロントエンド開発者は `client.api.quests.$get()` と入力するだけで、レスポンスの型推論やクエリパラメータのバリデーションエラーをエディタ上で即座に確認できる。
