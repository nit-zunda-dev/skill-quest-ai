# データベースアーキテクチャ (Cloudflare D1 + Drizzle)

Cloudflare D1はSQLiteベースの分散データベースであり、エッジでの読み取り性能に優れるが、書き込みの同時実行性には一定の制約（単一のリーダー）がある。この特性を考慮し、トランザクションを短く保つ設計が求められる。

## ORM選定: Drizzle ORM

Prismaと比較して、Drizzle ORMは以下の理由からCloudflare Workers環境に最適である。

- **軽量性**: ランタイムオーバーヘッドがほぼゼロであり、バンドルサイズが小さい
- **サーバーレス親和性**: HTTPリクエストごとの短命な接続に最適化されている
- **SQLライク**: SQLの知識を直接活かせるため、クエリのパフォーマンス予測が容易

## スキーマ設計 (ER図)

Better Authが必要とする認証系テーブルと、Skill Quest固有の業務ドメインテーブルを設計する。

### 認証モジュール (Better Auth標準)

Better Authの動作には以下のテーブルが必須となる。

| テーブル名 | 概要 | 主要カラム |
|-----------|------|-----------|
| `user` | ユーザー基本情報 | `id`, `name`, `email`, `image`, `createdAt` |
| `session` | セッション管理 | `id`, `userId`, `token`, `expiresAt`, `ipAddress` |
| `account` | OAuth連携情報 | `id`, `userId`, `providerId`, `accountId` |
| `verification` | メール確認等 | `id`, `identifier`, `value`, `expiresAt` |

### アプリケーション・クエストモジュール

アプリケーションの中核となるデータモデルである。

| テーブル名 | 概要 | 主要カラムとリレーション |
|-----------|------|------------------------|
| `skills` | 学習スキル定義 | `id` (PK), `slug`, `name`, `description` |
| `quests` | クエスト定義（ユーザー所有） | `id` (PK), `user_id` (FK), `skill_id` (FK), `title`, `scenario`, `difficulty`, `win_condition`, `status`, `completed_at` |
| `grimoire_entries` | タスク完了時の物語・報酬履歴 | `id` (PK), `user_id` (FK), `task_title`, `narrative`, `reward_xp`, `reward_gold` |
| `user_progress` | ユーザー・クエスト別進捗 | `id` (PK), `user_id` (FK), `quest_id` (FK), `status`, `score`, `completed_at` |
| `interaction_logs` | AIとの会話履歴 | `id` (PK), `progress_id` (FK), `role` (user/assistant), `content` (JSON), `created_at` |

### AI利用・制限用テーブル

| テーブル名 | 概要 | 主要カラム |
|-----------|------|-----------|
| `user_character_generated` | キャラ生成済みフラグ（1アカウント1回） | `user_id` (PK), `created_at` |
| `user_character_profile` | ユーザーキャラクタープロフィール（JSON） | `user_id` (PK), `profile` (JSON), `created_at` |
| `ai_daily_usage` | 日次AI利用回数（ナラティブ・パートナー・チャット等） | `user_id`, `date_utc` (PK), `narrative_count`, `partner_count`, `chat_count`, `grimoire_count`, `goal_update_count` |
| `rate_limit_logs` | レート制限ログ（連打防止） | `id` (PK), `user_id`, `endpoint`, `created_at` |

### 設計のポイント

- **JSONカラムの活用**: SQLite（D1）はJSONの扱いに長けている。`interaction_logs.content` や `user_character_profile.profile` などはJSON型で格納し、スキーマ変更の柔軟性を確保する。
- **外部キー制約**: D1は外部キー制約をサポートしているため、スキーマで `references` を定義し、データの整合性を担保する。

## マイグレーション戦略

D1へのスキーマ適用は `drizzle-kit` を使用する。開発環境（ローカル）と本番環境でフローを分離する。

1. **スキーマ変更**: `db/schema.ts` を修正
2. **マイグレーション生成**: `npx drizzle-kit generate` でSQLファイルを生成
3. **適用**:
   - ローカル: `wrangler d1 migrations apply skill-quest-db --local`
   - 本番: CI/CDパイプライン（GitHub Actions）で `wrangler d1 migrations apply` を実行
