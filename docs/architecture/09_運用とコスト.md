# 運用戦略とコスト分析

## コスト見積もり (月間アクティブユーザー 1,000人規模と仮定)

Cloudflareのエコシステムは、小〜中規模のトラフィックであれば非常に低コストで運用可能である。

| 項目 | プラン/条件 | 推定コスト (月額) | 備考 |
|-----|-----------|-----------------|------|
| Workers | Standard ($5/mo) | $5.00 | 月間1,000万リクエストまでカバー。Freeプランでも可 |
| D1 | Free / Paid | $0 - $5.00 | 読み込み操作が主であれば無料枠（500万Read）に収まる可能性が高い |
| Workers AI | Neurons Pricing | $10.00 - $30.00 | Llama 3 8Bは低コスト。OpenAI API利用時（推定$150以上）と比較して大幅に安価 |
| Pages | Free | $0 | 静的アセットの配信は無制限 |
| Better Auth | Self-hosted | $0 | ライセンス料なし |
| **合計** | | **$15.00 - $40.00** | 従来構成の1/5〜1/10程度のコスト |

## Free 枠での運用

Workers AI Freeプランでは **1日あたり 10,000 Neurons** まで無料。実測ではキャラ生成（Llama 3.1 8B）1回あたり **約 19 Neurons** 消費するため、キャラ生成のみなら約 500 回/日が目安となる。ナラティブ・パートナーメッセージ・チャットを加えると、少人数でも 1 日で上限に達しうる。

対策を講じた場合の目安（[06_AI設計.md](06_AI設計.md) の「ニューロン制約と対策」を参照）:

- **AI Gateway キャッシュ**: 同一プロンプトの再実行はニューロン 0。キャラ生成の「同じ名前・目標・ジャンル」や、パートナーメッセージの同一コンテキストはキャッシュで返せるため、実質の消費は初回のみ。
- **レート制限**: AI エンドポイントへの連打を防ぎ、乱用で枯渇するリスクを低減。
- **閾値超過時フォールバック**: 9,000 Neurons など閾値を超えたらスタブ応答に切り替え、サービスは継続しつつ上限超過・課金突入を防ぐ。

これらにより、開発〜小規模利用は Free 枠内で運用可能。ユーザー数が増えたら、本表の見積もりに従い Workers Paid + AI 有料利用（$10〜30/月程度）への移行を検討する。

## 運用監視 (Observability)

Cloudflare Dashboardでの基本的なメトリクス監視に加え、**Cloudflare AI Gateway** を導入する。これにより、以下の可観測性が得られる。

- AIリクエストのキャッシュ（同じ質問には推論なしで回答）
- プロンプトとレスポンスのログ記録
- トークン使用量とコストのリアルタイム追跡
