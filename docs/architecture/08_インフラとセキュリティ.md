# インフラストラクチャとセキュリティ

## 環境分離とデプロイメント

`wrangler.toml` を活用し、環境（Preview/Production）ごとに異なるD1データベースや環境変数をバインドする。

```toml
# wrangler.toml
name = "skill-quest-backend"
main = "src/index.ts"

# ローカル開発用
[[d1_databases]]
binding = "DB"
database_name = "skill-quest-db"
database_id = "local"

[ai]
binding = "AI"
remote = true

[vars]
FRONTEND_URL = "http://localhost:5173"

# プレビュー環境（Pull Request時など）
# 重要: [vars] と [ai] はルートから継承されないため、各環境セクションに明示的に追加する
[env.preview]
vars = { FRONTEND_URL = "https://preview-xxx.pages.dev" }
[env.preview.ai]
binding = "AI"
remote = true
[[env.preview.d1_databases]]
binding = "DB"
database_name = "skill-quest-db-preview"
database_id = "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"

# 本番環境
[env.production]
vars = { FRONTEND_URL = "https://your-app.pages.dev" }
[env.production.ai]
binding = "AI"
remote = true
[[env.production.d1_databases]]
binding = "DB"
database_name = "skill-quest-db-production"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

> **注意**: マイグレーションやD1確認コマンドは、デフォルトでローカルDBを参照する。リモート（デプロイ済みWorkerが接続するDB）に対して操作するには `--remote` を付けて実行する。詳細は [本番環境設定手順書](../setup/04_production_environment_setup.md) を参照。

## CI/CDパイプライン

モノレポ構成に対応したCI/CDパイプラインを構築する。**実装前に** [テスト戦略](./11_テスト戦略.md) と [デプロイ戦略](./12_デプロイ戦略.md) を策定し、設定はそれらに準拠する。

- **Check (GitHub Actions)**: PR作成時にESLint、TypeScript型チェック、単体テストを実行（[11_テスト戦略](./11_テスト戦略.md) に準拠）。`.github/workflows/check.yml` で定義。
- **Deploy (Cloudflare Git連携)**: Cloudflare Pages と Workers の Git 連携機能を使用して自動デプロイを実現（[12_デプロイ戦略](./12_デプロイ戦略.md) に準拠）。
  - **プレビュー**: `develop` ブランチへのマージで自動デプロイ
  - **本番**: `main` ブランチへのマージで自動デプロイ
  - **マイグレーション**: デプロイコマンド内で自動実行（デプロイ前にD1マイグレーションを適用）

## CORS許可オリジンと機密情報の取り扱い（本番運用）

本番運用に耐えるため、**許可するオリジンを明示**し、**機密情報はランタイム（Bindings）に限定**する。

### 本番で許可するオリジン（CORS）

- バックエンドの CORS は `apps/backend/src/middleware/index.ts` で、**許可リスト（allowlist）** により制御される。
- **許可リストの構成**:
  - **環境変数 `FRONTEND_URL`**: 各環境の `wrangler.toml` の `vars`（またはシークレット）で設定したフロントエンドのオリジン。**本番ではこの値を明示的に設定し、実際に利用するアプリのオリジンのみを許可する。**
  - **開発用の固定オリジン**（開発時のみ意味を持つ）: `http://localhost:3000`, `http://localhost:5173`, `http://localhost:8787`。本番の `FRONTEND_URL` に localhost を設定しない限り、本番ではこれらは許可されない。
- **環境ごとの推奨**:
  - **ローカル開発**: `wrangler.toml` の `[vars]` で `FRONTEND_URL = "http://localhost:3000"`（または 5173）とし、上記の localhost が許可される。
  - **プレビュー**: `[env.preview]` の `vars` で `FRONTEND_URL` をプレビュー用の Pages URL に設定（例: `https://develop.skill-quest-ai.pages.dev`）。
  - **本番**: `[env.production]` の `vars` で `FRONTEND_URL` を本番のアプリ URL に設定（例: `https://app.skill-quest-ai.com`）。**本番では許可したいオリジンがこの 1 つであれば、他は許可リストに含まれない。**

許可リストの変更はコード（`allowedOrigins` の追加）または環境ごとの `FRONTEND_URL` の設定で行う。新規オリジン追加時は、意図をレビューし、本番では必要最小限に留める。

### 機密情報をランタイム（Bindings）に限定する

- **方針**: 機密情報（秘密鍵、API キー、パスワード等）は**コードやクライアントに露出させず**、**ランタイムで注入**する。リポジトリにハードコードしない。
- **注入手段**:
  - **Cloudflare Bindings**: `wrangler.toml` の `[vars]` に**機密でない**値（例: `FRONTEND_URL`）を記載可能。機密は `wrangler secret put <KEY> --env <env>` で設定し、Worker の `c.env` から参照する。
  - 型は `apps/backend/src/types.ts` の `Bindings` で定義し、すべての機密・設定は `c.env` 経由でのみ参照する。
- **機密として扱うものの例**:
  - `BETTER_AUTH_SECRET`: セッション・Cookie 署名。必ず `wrangler secret put` で設定する。
  - `OPS_API_KEY`: 運用者 API の認可。設定時は `wrangler secret put` を推奨。
  - `AI_GATEWAY_ID`: 外部 AI ゲートウェイ利用時。`.dev.vars`（Git 管理外）または Cloudflare ダッシュボードの環境変数で設定。
  - その他、トークン・パスワード・メール本文等はログやレスポンスに含めない（構造化ログでもマスキングする）。
- **複数環境**: プレビューと本番で異なるシークレットを使う。`--env preview` / `--env production` を付けて環境ごとに `wrangler secret put` を実行する。環境ごとに適切な CORS（`FRONTEND_URL`）と機密の設定が可能である。

詳細な設定手順は [本番環境設定手順書](../setup/04_production_environment_setup.md) を参照する。

---

## セキュリティ対策

- **レート制限**: Workers内でのRate Limitingを行い、AIエンドポイントへの乱用（DDoSやトークン枯渇攻撃）を防ぐ。
- **入力サニタイズ**: Zodによる厳格なバリデーションに加え、Llama Guard等のセーフティモデルをAIパイプラインに組み込み、不適切なプロンプトインジェクションを防ぐ
- **SAST/SCA**: [Snyk](../setup/06_snyk_setup.md) によりコード・依存関係の脆弱性を静的解析で検出する。
- **DAST**: [OWASP ZAP](../setup/08_owasp_zap_setup.md) により、ローカルで起動したアプリを ZAP Desktop で動的セキュリティスキャンする。
