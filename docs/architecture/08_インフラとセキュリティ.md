# インフラストラクチャとセキュリティ

## 環境分離とデプロイメント

`wrangler.toml` を活用し、環境（Preview/Production）ごとに異なるD1データベースや環境変数をバインドする。

```toml
# wrangler.toml
name = "skill-quest-backend"
main = "src/index.ts"

# ローカル開発用
[[d1_databases]]
binding = "DB"
database_name = "skill-quest-db"
database_id = "local"

[ai]
binding = "AI"
remote = true

[vars]
FRONTEND_URL = "http://localhost:5173"

# プレビュー環境（Pull Request時など）
# 重要: [vars] と [ai] はルートから継承されないため、各環境セクションに明示的に追加する
[env.preview]
vars = { FRONTEND_URL = "https://preview-xxx.pages.dev" }
[env.preview.ai]
binding = "AI"
remote = true
[[env.preview.d1_databases]]
binding = "DB"
database_name = "skill-quest-db-preview"
database_id = "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"

# 本番環境
[env.production]
vars = { FRONTEND_URL = "https://your-app.pages.dev" }
[env.production.ai]
binding = "AI"
remote = true
[[env.production.d1_databases]]
binding = "DB"
database_name = "skill-quest-db-production"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

> **注意**: マイグレーションやD1確認コマンドは、デフォルトでローカルDBを参照する。リモート（デプロイ済みWorkerが接続するDB）に対して操作するには `--remote` を付けて実行する。詳細は [本番環境設定手順書](../setup/04_production_environment_setup.md) を参照。

## CI/CDパイプライン

モノレポ構成に対応したCI/CDパイプラインを構築する。**実装前に** [テスト戦略](./11_テスト戦略.md) と [デプロイ戦略](./12_デプロイ戦略.md) を策定し、設定はそれらに準拠する。

- **Check (GitHub Actions)**: PR作成時にESLint、TypeScript型チェック、単体テストを実行（[11_テスト戦略](./11_テスト戦略.md) に準拠）。`.github/workflows/check.yml` で定義。
- **Deploy (Cloudflare Git連携)**: Cloudflare Pages と Workers の Git 連携機能を使用して自動デプロイを実現（[12_デプロイ戦略](./12_デプロイ戦略.md) に準拠）。
  - **プレビュー**: `develop` ブランチへのマージで自動デプロイ
  - **本番**: `main` ブランチへのマージで自動デプロイ
  - **マイグレーション**: デプロイコマンド内で自動実行（デプロイ前にD1マイグレーションを適用）

## セキュリティ対策

- **レート制限**: Workers内でのRate Limitingを行い、AIエンドポイントへの乱用（DDoSやトークン枯渇攻撃）を防ぐ。
- **入力サニタイズ**: Zodによる厳格なバリデーションに加え、Llama Guard等のセーフティモデルをAIパイプラインに組み込み、不適切なプロンプトインジェクションを防ぐ
- **SAST/SCA**: [Snyk](../setup/06_snyk_setup.md) によりコード・依存関係の脆弱性を静的解析で検出する。
- **DAST**: [OWASP ZAP](../setup/08_owasp_zap_setup.md) により、ローカルで起動したアプリを ZAP Desktop で動的セキュリティスキャンする。
