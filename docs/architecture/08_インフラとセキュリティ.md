# インフラストラクチャとセキュリティ

## 環境分離とデプロイメント

`wrangler.toml` を活用し、環境（Preview/Production）ごとに異なるD1データベースや環境変数をバインドする。

```toml
# wrangler.toml
name = "skill-quest-backend"
main = "src/index.ts"

# ローカル開発用
[[d1_databases]]
binding = "DB"
database_name = "skill-quest-db"
database_id = "local"

[ai]
binding = "AI"
remote = true

[vars]
FRONTEND_URL = "http://localhost:5173"

# プレビュー環境（Pull Request時など）
# 重要: [vars] と [ai] はルートから継承されないため、各環境セクションに明示的に追加する
[env.preview]
vars = { FRONTEND_URL = "https://preview-xxx.pages.dev" }
[env.preview.ai]
binding = "AI"
remote = true
[[env.preview.d1_databases]]
binding = "DB"
database_name = "skill-quest-db-preview"
database_id = "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"

# 本番環境
[env.production]
vars = { FRONTEND_URL = "https://your-app.pages.dev" }
[env.production.ai]
binding = "AI"
remote = true
[[env.production.d1_databases]]
binding = "DB"
database_name = "skill-quest-db-production"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

> **注意**: マイグレーションやD1確認コマンドは、デフォルトでローカルDBを参照する。リモート（デプロイ済みWorkerが接続するDB）に対して操作するには `--remote` を付けて実行する。詳細は [本番環境設定手順書](../setup/04_production_environment_setup.md) を参照。

## CI/CDパイプライン (GitHub Actions)

モノレポ構成に対応したワークフローを構築する。

- **Check**: PR作成時にESLint、TypeScript型チェック、単体テストを実行
- **Preview**: mainブランチへのマージ前に、Cloudflare PagesおよびWorkersのプレビュー環境へデプロイ
- **Migration**: バックエンドのデプロイ前に、D1へのマイグレーションを適用
- **Deploy**: mainへのマージをトリガーに本番デプロイ

## セキュリティ対策

- **レート制限**: Cloudflare WAFおよびWorkers内でのRate Limitingを行い、AIエンドポイントへの乱用（DDoSやトークン枯渇攻撃）を防ぐ
- **入力サニタイズ**: Zodによる厳格なバリデーションに加え、Llama Guard等のセーフティモデルをAIパイプラインに組み込み、不適切なプロンプトインジェクションを防ぐ
