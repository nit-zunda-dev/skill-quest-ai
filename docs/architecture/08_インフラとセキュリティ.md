# インフラストラクチャとセキュリティ

## 環境分離とデプロイメント

`wrangler.toml` を活用し、環境（Preview/Production）ごとに異なるD1データベースや環境変数をバインドする。

```toml
# wrangler.toml
name = "skill-quest-backend"
main = "src/index.ts"

# 本番環境
[[d1_databases]]
binding = "DB"
database_name = "skill-quest-prod"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# プレビュー環境（Pull Request時など）
[env.preview]
[[env.preview.d1_databases]]
binding = "DB"
database_name = "skill-quest-dev"
database_id = "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"
```

## CI/CDパイプライン (GitHub Actions)

モノレポ構成に対応したワークフローを構築する。

- **Check**: PR作成時にESLint、TypeScript型チェック、単体テストを実行
- **Preview**: mainブランチへのマージ前に、Cloudflare PagesおよびWorkersのプレビュー環境へデプロイ
- **Migration**: バックエンドのデプロイ前に、D1へのマイグレーションを適用
- **Deploy**: mainへのマージをトリガーに本番デプロイ

## セキュリティ対策

- **レート制限**: Cloudflare WAFおよびWorkers内でのRate Limitingを行い、AIエンドポイントへの乱用（DDoSやトークン枯渇攻撃）を防ぐ
- **入力サニタイズ**: Zodによる厳格なバリデーションに加え、Llama Guard等のセーフティモデルをAIパイプラインに組み込み、不適切なプロンプトインジェクションを防ぐ
