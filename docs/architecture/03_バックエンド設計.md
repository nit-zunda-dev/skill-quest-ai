# バックエンドアーキテクチャ (Hono on Workers)

HonoはCloudflare Workersのランタイムに最適化された超軽量フレームワークであり、Express.jsライクなAPIを持ちながら、Web標準の `Request`/`Response` オブジェクトを直接扱う。

## ミドルウェアとコンテキスト注入

Cloudflare Workersでは、環境変数やデータベースバインディング（`env.DB`, `env.AI`）はリクエストごとのコンテキスト `c.env` に格納される。グローバルな `process.env` は存在しない（または非推奨）ため、Honoのミドルウェアパターンを用いてこれらをハンドラに注入する設計とする。

```typescript
type Bindings = {
  DB: D1Database
  AI: Ai
  BETTER_AUTH_SECRET: string
  GITHUB_CLIENT_ID: string
  GITHUB_CLIENT_SECRET: string
}

const app = new Hono<{ Bindings: Bindings }>()

app.use('*', async (c, next) => {
  // 共通のロギングやエラーハンドリングをここに記述
  await next()
})
```

## エラーハンドリングとバリデーション

Honoの `zod-validator` を使用し、入力値の検証を行う。検証ルール（Zodスキーマ）は `packages/shared` に配置し、フロントエンドのフォームバリデーションとも共有することで、二重管理を防ぐ。

```typescript
// shared/src/schema.ts
import { z } from 'zod'

export const createQuestSchema = z.object({
  title: z.string().min(5),
  difficulty: z.number().min(1).max(5),
  scenario: z.string()
})

// backend/src/routes/quests.ts
import { zValidator } from '@hono/zod-validator'
import { createQuestSchema } from '@skill-quest/shared'

app.post('/', zValidator('json', createQuestSchema), async (c) => {
  const data = c.req.valid('json')
  // ... DB保存処理
})
```
