# フロントエンドアーキテクチャ拡張

既存の `skill-quest-ai` フロントエンドをベースにしつつ、CrewAI依存部分を排除し、Hono RPCとの接続を行う。

## フォルダ構成

ソースはすべて `apps/frontend/src/` 以下に集約し、エントリ・コンポーネント・フック・ライブラリを一貫したパスで参照する。

```
apps/frontend/
├── index.html              # HTML エントリ（script で src/main.tsx を参照）
├── package.json
├── tsconfig.json
├── vite.config.ts          # resolve.alias: @ → src
├── vitest.config.ts
└── src/
    ├── main.tsx             # アプリケーションエントリ（React マウント・QueryClientProvider）
    ├── App.tsx              # ルートコンポーネント（モード切替・Genesis / Dashboard）
    ├── components/          # UI コンポーネント
    │   ├── Dashboard.tsx
    │   ├── GenesisStep.tsx
    │   ├── Grimoire.tsx
    │   ├── PartnerWidget.tsx
    │   ├── QuestBoard.tsx
    │   ├── RadarChart.tsx
    │   ├── ResultStep.tsx
    │   └── StatusPanel.tsx
    ├── hooks/               # データ取得・副作用用カスタムフック
    │   ├── useProfile.ts
    │   ├── useProfile.test.tsx
    │   ├── useQuests.ts
    │   └── useQuests.test.tsx
    └── lib/                  # API クライアント・設定・ユーティリティ
        ├── api-client.ts      # AI 生成 API（キャラクター・ナラティブ・パートナーメッセージ）
        ├── app-type.ts       # バックエンド AppType の再エクスポート
        ├── client.ts         # Hono RPC クライアント
        ├── client.test.ts
        ├── query.ts          # TanStack Query クライアント生成
        └── query.test.ts
```

- **インポート**: `@/` は `src/` を指す。例: `import { client } from '@/lib/client'`, `import X from '@/components/Dashboard'`。
- **テスト**: 単体テストは対象ファイルと同じディレクトリに `*.test.ts` / `*.test.tsx` で配置する（colocate）。

## フォルダ構成の拡張方針

今後の機能追加時は、次のルールで配置する。

| 追加するもの | 配置先 | 備考 |
|-------------|--------|------|
| 新規ページ・画面 | `src/pages/` | ルーティング導入時に `pages/Home.tsx`, `pages/QuestDetail.tsx` などを追加。現状は `App.tsx` 内でモード切替。 |
| 共通 UI パーツ | `src/components/ui/` | ボタン・カード・モーダルなど再利用コンポーネント。機能固有は `components/` 直下または `features/` 内。 |
| 機能単位のまとまり | `src/features/<機能名>/` | 機能が大きくなった場合。例: `features/auth/` に `LoginForm.tsx`, `hooks/useAuth.ts`, `api.ts` をまとめる。 |
| 新規 API 呼び出し | `src/lib/` または機能内 | 汎用クライアントは `lib/`。認証は `lib/auth-client.ts`（設計済み）。 |
| 新規データ取得フック | `src/hooks/` | `useQuests`, `useProfile` と同様に TanStack Query ベースで追加。 |
| ルーティング | `src/routes/` または `App.tsx` | ルーター導入時は `routes/index.tsx` でルート定義し、`App.tsx` で `<Router>` をマウント。 |
| グローバル状態・コンテキスト | `src/contexts/` または `src/stores/` | 必要になったら作成。サーバー状態は TanStack Query を優先。 |
| 定数・型（共有） | `src/lib/` または `@skill-quest/shared` | フロント専用の型・定数は `lib/constants.ts`, `lib/types.ts` など。 |

- **方針**: まずはレイヤー別（`components/`, `hooks/`, `lib/`）で拡張し、機能がまとまったら `features/<名前>/` へ移行してもよい。
- **命名**: コンポーネントは PascalCase、フックは `use*`、ユーティリティは camelCase のファイル名とする。

## ステート管理 (TanStack Query)

サーバー状態（クエスト一覧、ユーザープロファイル）の管理には、**TanStack Query (React Query)** を採用する。これにより、キャッシュ、自動リフェッチ、ローディング状態の管理が容易になる。

Hono Clientと組み合わせることで、以下のような型安全なデータフェッチが可能になる。

```typescript
// hooks/useQuests.ts
import { useQuery } from '@tanstack/react-query'
import { client } from '@/lib/client'

export const useQuests = () => {
  return useQuery({
    queryKey: ['quests'],
    queryFn: async () => {
      const res = await client.api.quests.$get()
      if (!res.ok) throw new Error('Failed to fetch')
      return await res.json() // ここで型推論が効く
    }
  })
}
```

## AIチャットUIの実装

AIからのストリーミングレスポンスを表示するため、カスタムフック `useChat` を実装する。Vercel AI SDKの `useChat` フックを利用することも可能だが、Cloudflare Workers AIのストリーム形式に合わせるため、軽量な独自実装または `ai` パッケージの `StreamingTextResponse` 対応アダプタの利用を検討する。

## 認証UI

Better AuthはReact用クライアントライブラリを提供している。`apps/frontend/src/lib/auth-client.ts` を作成し、ログイン、ログアウト、セッション取得のメソッドをコンポーネントから利用する。
