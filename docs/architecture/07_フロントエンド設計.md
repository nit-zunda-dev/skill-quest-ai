# フロントエンドアーキテクチャ

React + Vite + TanStack Query をベースとし、Hono RPC クライアントでバックエンドと型安全に通信する。

## フォルダ構成

ソースはすべて `apps/frontend/src/` 以下に集約し、エントリ・コンポーネント・フック・ライブラリを一貫したパスで参照する。

```
apps/frontend/
├── index.html
├── package.json
├── tsconfig.json
├── vite.config.ts          # resolve.alias: @ → src
├── vitest.config.ts
└── src/
    ├── main.tsx             # エントリ（React マウント・QueryClientProvider）
    ├── App.tsx              # ルート（認証・Genesis / 認証済みアプリの切り替え）
    ├── components/          # UI コンポーネント
    │   ├── LandingPage.tsx
    │   ├── LoginSignupForm.tsx
    │   ├── GenesisStep.tsx   # INTRO / QUESTIONS / LOADING
    │   ├── SuggestStep.tsx   # クエスト提案（目標入力→AI提案）
    │   ├── SuggestedQuestsModal.tsx
    │   ├── ResultStep.tsx
    │   ├── GoalUpdateUI.tsx
    │   ├── QuestBoard.tsx
    │   ├── Grimoire.tsx
    │   ├── PartnerWidget.tsx
    │   ├── StatusPanel.tsx
    │   └── ui/               # 共通UI（button, card 等）
    ├── pages/                # ルート別ページ
    │   ├── HomePage.tsx
    │   ├── QuestBoardPage.tsx
    │   ├── GrimoirePage.tsx
    │   ├── PartnerPage.tsx
    │   └── ItemsPage.tsx
    ├── layouts/
    │   └── AppLayout.tsx     # 認証済み時のレイアウト・ナビ
    ├── contexts/
    │   └── ProfileContext.tsx
    ├── hooks/
    │   ├── useAuth.tsx
    │   ├── useProfile.ts
    │   ├── useQuests.ts
    │   ├── useGenesisOrProfile.ts
    │   ├── useAiUsage.ts
    │   ├── useGrimoire.ts
    │   ├── useChat.ts
    │   └── useSuggestQuests.ts
    └── lib/
        ├── client.ts         # Hono RPC クライアント
        ├── app-type.ts       # AppType 再エクスポート
        ├── api-client.ts     # AI 生成 API（キャラ・ナラティブ・パートナー等）
        ├── auth-client.ts
        ├── query.ts          # TanStack Query クライアント
        └── utils.ts
```

- **インポート**: `@/` は `src/` を指す。例: `import { client } from '@/lib/client'`, `import HomePage from '@/pages/HomePage'`。
- **テスト**: 単体テストは対象ファイルと同じディレクトリに `*.test.ts` / `*.test.tsx` で配置する（colocate）。

## ルーティング

認証済みユーザーは `BrowserRouter` + `Routes` で以下のルートを利用する。

- `/` — HomePage（ダッシュボード）
- `/quests` — QuestBoardPage
- `/grimoire` — GrimoirePage
- `/partner` — PartnerPage
- `/items` — ItemsPage

`AppLayout` が共通レイアウトとナビゲーションを提供する。

## フォルダ構成の拡張方針

| 追加するもの | 配置先 | 備考 |
|-------------|--------|------|
| 新規ページ | `src/pages/` | ルート定義は `App.tsx` 内の `<Routes>` に追加。 |
| 共通 UI パーツ | `src/components/ui/` | ボタン・カード・モーダルなど。機能固有は `components/` 直下または `features/` 内。 |
| 機能単位のまとまり | `src/features/<機能名>/` | 機能が大きくなった場合にまとめて配置。 |
| 新規 API 呼び出し | `src/lib/` または機能内 | 汎用は `lib/`。認証は `lib/auth-client.ts`。 |
| 新規データ取得フック | `src/hooks/` | TanStack Query ベースで追加。 |
| グローバル状態・コンテキスト | `src/contexts/` または `src/stores/` | サーバー状態は TanStack Query を優先。 |
| 定数・型（共有） | `src/lib/` または `@skill-quest/shared` | フロント専用は `lib/constants.ts`, `lib/types.ts` など。 |

- **命名**: コンポーネントは PascalCase、フックは `use*`、ユーティリティは camelCase のファイル名とする。

## ステート管理 (TanStack Query)

サーバー状態（クエスト一覧、ユーザープロファイル）の管理には、**TanStack Query (React Query)** を採用する。これにより、キャッシュ、自動リフェッチ、ローディング状態の管理が容易になる。

Hono Clientと組み合わせることで、以下のような型安全なデータフェッチが可能になる。

```typescript
// hooks/useQuests.ts
import { useQuery } from '@tanstack/react-query'
import { client } from '@/lib/client'

export const useQuests = () => {
  return useQuery({
    queryKey: ['quests'],
    queryFn: async () => {
      const res = await client.api.quests.$get()
      if (!res.ok) throw new Error('Failed to fetch')
      return await res.json() // ここで型推論が効く
    }
  })
}
```

## AIチャットUIの実装

AIからのストリーミングレスポンスを表示するため、カスタムフック `useChat` を実装する。Vercel AI SDKの `useChat` フックを利用することも可能だが、Cloudflare Workers AIのストリーム形式に合わせるため、軽量な独自実装または `ai` パッケージの `StreamingTextResponse` 対応アダプタの利用を検討する。

## 認証UI

Better Auth の React 用クライアントを `apps/frontend/src/lib/auth-client.ts` で利用する。ログイン・ログアウト・セッション取得は `useAuth` 経由でコンポーネントから利用する。
