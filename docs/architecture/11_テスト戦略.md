# テスト戦略

本ドキュメントは、Skill Quest AI の CI およびローカル開発で実行するテストの範囲・種類・方針を定義します。GitHub Actions ワークフロー（check / deploy）は本戦略に準拠して実装します。

## 1. テストピラミッドと対象

| 層 | 目的 | 主な対象 | 実行環境 | 目標割合 |
|----|------|----------|----------|----------|
| **単体テスト** | 関数・モジュール単位の振る舞い検証 | ビジネスロジック、ユーティリティ、スキーマ、ミドルウェア | CI / ローカル | 70-80% |
| **統合テスト** | API・DB・外部サービス境界の検証 | ルートハンドラ + D1（ローカル）、認証フロー | CI / ローカル（オプション） | 15-25% |
| **E2E** | ユーザー操作と画面遷移の検証 | 認証〜クエスト操作〜AIチャット | 手動（初期） | 5-10% |

- **方針**: 単体テストを主体（70-80%）とし、CI では必ず実行する。統合テストは D1 ローカルバインディングまたはスタブで実行し、Workers AI はスタブまたはスキップ条件で扱う。E2E は初期は手動を想定し、必要に応じて Playwright 等を導入する。

## 2. モノレポ各パッケージのテスト方針

| パッケージ | テスト内容 | 備考 |
|------------|------------|------|
| **apps/frontend** | コンポーネント単体（Testing Library）、フック・クライアントのモック利用 | Vitest + @testing-library/react。API はモック |
| **apps/backend** | ルートハンドラの単体（リクエスト/レスポンス）、設定ファイル検証（例: wrangler.toml）、必要に応じて D1 統合 | Vitest、node 環境。D1 は `wrangler d1 execute --local` または Miniflare でローカル利用可 |
| **packages/shared** | 型エクスポートと Zod スキーマのバリデーション単体テスト | スキーマの parse / safeParse のテストを推奨 |

- **packages/config**: 設定の適用確認は各アプリの `lint` / `type-check` で間接的に検証。専用テストは不要とする。

## 3. CI で実行するチェック一覧

PR 作成時および main ブランチへのマージ時に次を実行する。

| チェック | コマンド | 対象 | 失敗時の扱い |
|----------|----------|------|--------------|
| Lint | `pnpm run lint`（Turbo でワークスペース一括） | 全パッケージ | PR マージブロック |
| 型チェック | `pnpm run type-check`（Turbo でワークスペース一括） | frontend, backend, shared | PR マージブロック |
| ビルド | `pnpm run build`（Turbo でワークスペース一括） | frontend, backend | PR マージブロック |
| 単体テスト | `pnpm run test`（Turbo でワークスペース一括） | frontend, backend, shared の `**/*.test.ts` 等 | PR マージブロック |

- **実行順序**: Lint → 型チェック → ビルド → 単体テスト（Turbo の依存関係に従う）
- **並列実行**: Turbo により、依存関係のないパッケージは並列実行される
- **カバレッジ**: 初回は閾値なしでレポートのみ取得し、慣れてから最低ライン（例: 60%）を設定することを推奨する。カバレッジレポートは CI の成果物として保存する
- **ビルド**: `pnpm run build` を CI で実行し、本番ビルドが通ることを保証する（Turbo の `test` は `build` に依存しているため、ビルド成功後にテストが実行される）

## 4. 統合テスト・E2E の実行タイミング

### 統合テスト（API + D1）

- **PR 時**: オプションで実行するか、main マージ後のプレビュー環境で手動検証
- **CI で常時実行する場合**: D1 をローカルバインディング（`wrangler d1 execute --local`）で利用する構成とする
- **実行環境**: ローカル D1 データベースまたは Miniflare を使用
- **対象**: 認証フロー、クエスト CRUD 操作、AI エンドポイント（スタブ使用）

### E2E テスト

- **自動化**: Playwright で認証フロー等の E2E を実装済み。ローカル・CI の実行方法は [E2E テストの実行と CI 準備](../setup/07_e2e_test_setup.md) を参照
- **実行タイミング**:
  - ローカル: サーバー起動後に `pnpm test:e2e:local` で実行
  - CI: 現状は E2E ステップ未追加。CI で通すにはプレビュー環境のデプロイとワークフロー拡張（タスク 7.3）が必要

## 5. テストデータ・モック・Workers AI の扱い

### D1 データベース

- **ローカル開発**: `wrangler d1 execute --local` で作成した DB を使用
- **CI 実行**: `--local` でマイグレーション適用＋テストデータ投入スクリプトを用意するか、インメモリ SQLite で代替可能な範囲で単体化する
- **テストデータ**: 各テスト前にデータベースをリセットし、必要なテストデータのみを投入する（テストの独立性を保証）

### Workers AI（env.AI）

- **単体・統合テスト**: 呼び出さない（コストとレイテンシを避けるため）
- **テスト方法**: 
  - AI を利用するルートは「AI レスポンスをスタブしたハンドラ」でテストする
  - または、該当テストを `env.AI` が未定義の場合はスキップする（`if (!env.AI) test.skip()`）
- **スタブの例**: `generateCharacter` 関数のテストでは、期待される JSON レスポンスをモックして返す

### 認証（Better Auth）

- **セッション検証**: モックまたはテスト用トークンで通過させ、エンドポイントの入力・出力と HTTP ステータスのみ検証する
- **テスト用トークン**: テスト専用のセッショントークンを生成し、認証が必要なエンドポイントのテストで使用する
- **認証エラー**: 無効なトークンや未認証リクエストで 401 Unauthorized が返されることを検証する

## 6. テストツールと設定

### 使用ツール

- **Vitest**: 単体テスト・統合テストの実行環境（frontend, backend, shared）
- **@testing-library/react**: フロントエンドコンポーネントのテスト
- **Playwright**: E2E テスト（認証フロー・画面遷移）。詳細は [E2E テストの実行と CI 準備](../setup/07_e2e_test_setup.md) を参照
- **Miniflare**: Workers 環境のローカルエミュレーション（統合テスト用、オプション）

### テストファイルの命名規則

- 単体テスト: `*.test.ts` または `*.test.tsx`
- 統合テスト: `*.integration.test.ts`
- E2E テスト: `*.e2e.test.ts`（将来の拡張）

### テストの実行方法

```bash
# 全パッケージのテストを実行
pnpm run test

# 特定のパッケージのテストを実行
pnpm --filter @skill-quest/backend test
pnpm --filter @skill-quest/frontend test

# ウォッチモード（ローカル開発）
pnpm --filter @skill-quest/backend test:watch
pnpm --filter @skill-quest/frontend test:watch
```

## 7. 本ドキュメントの更新

- 新しいテスト種別や CI ジョブを追加する際は、本戦略を更新し、タスク 13.2 で定義するワークフローと整合させること
- テストピラミッドの割合やカバレッジ閾値は、プロジェクトの成熟度に応じて見直すこと
