# デプロイ戦略

本ドキュメントは、Skill Quest AI の環境定義、デプロイトリガー、マイグレーション適用、ロールバック方針を定義します。Cloudflare Pages と Workers の Git 連携機能を使用して自動デプロイを実現します。

## 1. 環境の定義とブランチとの対応

| 環境 | 用途 | ブランチ／トリガー | フロントエンド | バックエンド |
|------|------|-------------------|----------------|--------------|
| **local** | 開発者の手元 | 手動 `pnpm dev` / `wrangler dev` | Vite dev server | Wrangler dev（D1 --local） |
| **preview** | PR 検証・ステージング | `develop` ブランチへのマージ（自動）、または手動デプロイ | Cloudflare Pages (preview) | Cloudflare Workers (env.preview) |
| **production** | 本番トラフィック | `main` ブランチへのマージ（自動） | Cloudflare Pages (production) | Cloudflare Workers (env.production) |

- **preview** と **production** では、それぞれ別の D1 データベース（`skill-quest-db-preview` / `skill-quest-db-production`）と環境変数（`wrangler.toml` の `[env.preview]` / `[env.production]`）を使用する。

## 2. デプロイトリガーと方法

- **プレビュー（preview）**: 
  - **自動デプロイ**: `develop` ブランチへのマージ（push）をトリガーに、Cloudflare Pages と Workers のプレビュー環境へ自動デプロイする。Cloudflare Dashboard で Git リポジトリと連携し、「非本番ブランチのビルド」を有効化することで実現する。
  - **手動デプロイ**: Cloudflare Dashboard から手動でデプロイを実行できる。緊急時の修正や検証用途で使用する。
- **本番（production）**: `main` ブランチへのマージ（push）をトリガーに、Cloudflare Pages と Workers の本番環境へ自動デプロイする。Cloudflare Dashboard で Git リポジトリと連携し、`main` ブランチを本番ブランチとして設定することで実現する。

### 2.1 Cloudflare Git 連携による自動デプロイ

- **Cloudflare Pages**: 既に Git リポジトリと連携しており、`main` ブランチへの push で本番、その他のブランチでプレビューが自動デプロイされる。
- **Cloudflare Workers**: Cloudflare Dashboard の「設定」→「ビルド」セクションから Git リポジトリと連携し、以下の設定を行う：
  - **本番環境（production）**: `main` ブランチを選択、ビルドコマンド `pnpm --filter @skill-quest/backend build`、デプロイコマンド `npx wrangler deploy --env production`
  - **プレビュー環境（preview）**: 「非本番ブランチのビルド」を有効化、`develop` ブランチを対象に、デプロイコマンド `npx wrangler deploy --env preview` を設定

## 3. マイグレーションの適用タイミングと順序

### 3.1 適用タイミング

- **適用タイミング**: バックエンド（Workers）のデプロイ**前**に、対象環境の D1 に対してマイグレーションを適用する。
  - **本番デプロイ時**: Cloudflare Workers の Git 連携設定で、デプロイコマンドの前にマイグレーションを実行するスクリプトを呼び出すか、または手動で `wrangler d1 migrations apply skill-quest-db-production --remote --env production` を実行してからデプロイする。
  - **プレビューデプロイ時**: 同様に `wrangler d1 migrations apply skill-quest-db-preview --remote --env preview` を実行してからデプロイする。

### 3.2 デプロイ順序

以下の順序でデプロイを実行する：

1. **D1 マイグレーション適用**（対象環境のリモート D1）
   ```bash
   # 本番環境
   pnpm --filter @skill-quest/backend exec wrangler d1 migrations apply skill-quest-db-production --remote --env production
   
   # プレビュー環境
   pnpm --filter @skill-quest/backend exec wrangler d1 migrations apply skill-quest-db-preview --remote --env preview
   ```

2. **Cloudflare Workers（backend）のデプロイ**
   ```bash
   # 本番環境
   pnpm --filter @skill-quest/backend exec wrangler deploy --env production
   
   # プレビュー環境
   pnpm --filter @skill-quest/backend exec wrangler deploy --env preview
   ```

3. **Cloudflare Pages（frontend）のデプロイ**（Git 連携の場合は push に連動して自動実行）

- **理由**: フロントエンドはバックエンド API に依存するため、バックエンドを先にデプロイする必要がある。

### 3.3 自動化の実装

Cloudflare Workers の Git 連携では、デプロイコマンドの前にマイグレーションを自動実行するには、以下のいずれかの方法を使用する：

**方法1: デプロイコマンドを結合**
```bash
cd apps/backend && pnpm exec wrangler d1 migrations apply skill-quest-db-production --remote --env production && pnpm exec wrangler deploy --env production
```

**方法2: package.json にデプロイスクリプトを定義**
```json
{
  "scripts": {
    "deploy:production": "wrangler d1 migrations apply skill-quest-db-production --remote --env production && wrangler deploy --env production",
    "deploy:preview": "wrangler d1 migrations apply skill-quest-db-preview --remote --env preview && wrangler deploy --env preview"
  }
}
```

### 3.4 マイグレーション失敗時の対応

- **マイグレーション失敗時**: デプロイを中断し、エラーを確認する。後方互換性のない変更が原因の場合は、ロールバック用のダウンマイグレーションを準備する。
- **検証**: マイグレーション適用後、`wrangler d1 execute` でテーブル構造を確認する。

## 4. Cloudflare Pages と Workers のデプロイ順序と依存関係

### 4.1 デプロイ順序

1. **D1 マイグレーション**（対象環境のリモート D1）
2. **Cloudflare Workers（backend）** のデプロイ（`wrangler deploy --env production` または `--env preview`）
3. **Cloudflare Pages（frontend）** のデプロイ（`pnpm build` 成果物のアップロード、または Git 連携の場合は push に連動）

### 4.2 環境変数の設定

- **フロントエンド**: ビルド時に `VITE_API_URL` 等で参照する API のベース URL は、環境ごとに異なる値とする（本番用・プレビュー用）。Cloudflare Pages の環境変数で注入する。
  - **本番環境**: `VITE_API_URL=https://skill-quest-backend.your-subdomain.workers.dev`
  - **プレビュー環境**: `VITE_API_URL=https://skill-quest-backend-preview.your-subdomain.workers.dev`
- **バックエンド**: `wrangler.toml` の `[env.preview]` / `[env.production]` セクションで環境変数を設定する。

### 4.3 デプロイの依存関係

- **フロントエンド → バックエンド**: フロントエンドはバックエンド API に依存するため、バックエンドを先にデプロイする必要がある。
- **バックエンド → D1**: バックエンドは D1 データベースに依存するため、マイグレーションを先に適用する必要がある。

## 5. デプロイ前後の検証とモニタリング

### 5.1 デプロイ前の検証

- **CI チェック**: PR 作成時に GitHub Actions で以下を実行（[テスト戦略](./11_テスト戦略.md) に準拠）
  - Lint チェック
  - 型チェック
  - ビルド確認
  - 単体テスト
- **ローカル検証**: デプロイ前にローカルで以下を確認
  - `pnpm run build` が成功することを確認
  - `pnpm run test` がすべてパスすることを確認
  - `wrangler dev` でローカル動作を確認（可能な範囲で）

### 5.2 デプロイ後の検証

- **ヘルスチェック**: デプロイ完了後、以下のエンドポイントで動作確認
  - バックエンド: `GET /api/health` または類似のヘルスチェックエンドポイント
  - フロントエンド: トップページが正常に表示されることを確認
- **機能確認**: 主要な機能が正常に動作することを確認
  - 認証フロー（ログイン・ログアウト）
  - API エンドポイントの応答
  - AI 機能（可能な範囲で）

### 5.3 モニタリング

- **Cloudflare Dashboard**: デプロイの成功・失敗を Cloudflare Dashboard で確認
- **エラーログ**: Cloudflare Workers のログストリームでエラーを監視
- **パフォーマンス**: Cloudflare Analytics でレスポンスタイムやエラー率を確認

## 6. ロールバック手順とリリース判定基準

### 6.1 リリース判定基準

「main にマージされ、Cloudflare の Git 連携による自動デプロイが成功し、Cloudflare 上で本番 Worker と Pages が更新完了した時点」を本番リリースとする。

**具体的な判定条件**:
1. GitHub の `main` ブランチにマージされている
2. Cloudflare Dashboard でデプロイが成功している（エラーがない）
3. デプロイ後の検証（5.2）が完了している

### 6.2 ロールバック手順

#### コードのロールバック

**方法1: Git で前のコミットに戻す**
```bash
# 前のコミットを確認
git log --oneline

# 前のコミットに戻す（例: コミットハッシュ abc123）
git revert abc123
git push origin main
# または
git reset --hard abc123
git push --force origin main  # 注意: チームと相談してから実行
```

**方法2: Cloudflare Dashboard からロールバック**
- Cloudflare Dashboard の「デプロイ」タブから「前のデプロイ」に切り戻す
- この方法は Cloudflare Pages と Workers の両方で利用可能

**方法3: 緊急時の手動デプロイ**
- 前のバージョンのコードを手動でデプロイする

#### マイグレーションのロールバック

- **後方互換性のある変更**: 通常はロールバック不要（新しいコードが古いスキーマでも動作する）
- **後方互換性のない変更**: ダウンマイグレーション用 SQL を別途用意し、手動で `wrangler d1 execute` を実行する
  ```bash
  # ダウンマイグレーション SQL を実行
  pnpm --filter @skill-quest/backend exec wrangler d1 execute skill-quest-db-production --remote --env production --file=./migrations/rollback.sql
  ```
- **自動ロールバック**: 初版では対象外とする（将来的に検討）

### 6.3 ロールバックの判断基準

以下の場合にロールバックを検討する：
- デプロイ後に重大なエラーが発生し、サービスが利用できない
- パフォーマンスが著しく低下している
- セキュリティ上の問題が発見された
- データの整合性に問題が発生した

## 7. ブランチ戦略

### 7.1 ブランチ構成

- **develop ブランチ**: プレビュー環境への自動デプロイの対象。機能開発やバグ修正をこのブランチにマージして検証する。
- **main ブランチ**: 本番環境への自動デプロイの対象。develop で検証済みのコードをマージする。

### 7.2 ワークフロー

1. **機能開発**: 機能ブランチ（例: `feature/xxx`）を作成して開発
2. **プレビュー検証**: `develop` ブランチにマージ → プレビュー環境に自動デプロイ → 検証
3. **本番リリース**: `main` ブランチにマージ → 本番環境に自動デプロイ

### 7.3 PR 戦略

- **develop への PR**: 機能ブランチから `develop` への PR を作成し、レビュー後にマージ
- **main への PR**: `develop` から `main` への PR を作成し、レビュー後にマージ（または直接マージ）

## 8. GitHub Actions との統合

### 8.1 CI パイプライン

GitHub Actions で PR 作成時に以下を実行（[テスト戦略](./11_テスト戦略.md) に準拠）：
- Lint チェック
- 型チェック
- ビルド確認
- 単体テスト

詳細は `.github/workflows/check.yml` を参照。

### 8.2 CD パイプライン

- **Cloudflare Git 連携**: Cloudflare Pages と Workers の Git 連携機能を使用して自動デプロイを実現
- **GitHub Actions との併用**: GitHub Actions で CI を実行し、Cloudflare Git 連携で CD を実行する構成

## 9. エラーハンドリングとトラブルシューティング

### 9.1 デプロイ失敗時の対応

- **ビルドエラー**: Cloudflare Dashboard のデプロイログを確認し、エラー原因を特定する
- **マイグレーションエラー**: D1 のマイグレーションログを確認し、スキーマの不整合を修正する
- **環境変数の不足**: `wrangler.toml` と Cloudflare Dashboard の環境変数を確認する

### 9.2 よくある問題と解決方法

| 問題 | 原因 | 解決方法 |
|------|------|----------|
| デプロイが失敗する | ビルドエラー | ローカルで `pnpm run build` を実行してエラーを確認 |
| API が動作しない | 環境変数の設定漏れ | `wrangler.toml` と Cloudflare Dashboard を確認 |
| マイグレーションが適用されない | マイグレーションファイルのパス | `wrangler.toml` の `migrations_dir` を確認 |
| フロントエンドが API に接続できない | `VITE_API_URL` の設定 | Cloudflare Pages の環境変数を確認 |

## 10. 本ドキュメントの更新

- 新しい環境の追加やトリガー・順序を変更する際は、本戦略を更新し、Cloudflare Dashboard での Git 連携設定と整合させること
- GitHub Actions ワークフロー（`.github/workflows/`）を変更する際は、本戦略と整合させること
- デプロイ手順やロールバック手順を変更する際は、チームでレビューし、合意を得ること
