# デプロイ戦略

本ドキュメントは、Skill Quest AI の環境定義、デプロイトリガー、マイグレーション適用、ロールバック方針を定義します。Cloudflare Pages と Workers の Git 連携機能を使用して自動デプロイを実現します。

## 1. 環境の定義とブランチとの対応

| 環境 | 用途 | ブランチ／トリガー | フロントエンド | バックエンド |
|------|------|-------------------|----------------|--------------|
| **local** | 開発者の手元 | 手動 `pnpm dev` / `wrangler dev` | Vite dev server | Wrangler dev（D1 --local） |
| **preview** | PR 検証・ステージング | `develop` ブランチへのマージ（自動）、または手動デプロイ | Cloudflare Pages (preview) | Cloudflare Workers (env.preview) |
| **production** | 本番トラフィック | `main` ブランチへのマージ（自動） | Cloudflare Pages (production) | Cloudflare Workers (env.production) |

- **preview** と **production** では、それぞれ別の D1 データベース（`skill-quest-db-preview` / `skill-quest-db-production`）と環境変数（`wrangler.toml` の `[env.preview]` / `[env.production]`）を使用する。

## 2. デプロイトリガーと方法

- **プレビュー（preview）**: 
  - **自動デプロイ**: `develop` ブランチへのマージ（push）をトリガーに、Cloudflare Pages と Workers のプレビュー環境へ自動デプロイする。Cloudflare Dashboard で Git リポジトリと連携し、「非本番ブランチのビルド」を有効化することで実現する。
  - **手動デプロイ**: Cloudflare Dashboard から手動でデプロイを実行できる。緊急時の修正や検証用途で使用する。
- **本番（production）**: `main` ブランチへのマージ（push）をトリガーに、Cloudflare Pages と Workers の本番環境へ自動デプロイする。Cloudflare Dashboard で Git リポジトリと連携し、`main` ブランチを本番ブランチとして設定することで実現する。

### 2.1 Cloudflare Git 連携による自動デプロイ

- **Cloudflare Pages**: 既に Git リポジトリと連携しており、`main` ブランチへの push で本番、その他のブランチでプレビューが自動デプロイされる。
- **Cloudflare Workers**: Cloudflare Dashboard の「設定」→「ビルド」セクションから Git リポジトリと連携し、以下の設定を行う：
  - **本番環境（production）**: `main` ブランチを選択、ビルドコマンド `pnpm --filter @skill-quest/backend build`、デプロイコマンド `npx wrangler deploy --env production`
  - **プレビュー環境（preview）**: 「非本番ブランチのビルド」を有効化、`develop` ブランチを対象に、デプロイコマンド `npx wrangler deploy --env preview` を設定

## 3. マイグレーションの適用タイミングと順序

- **適用タイミング**: バックエンド（Workers）のデプロイ**前**に、対象環境の D1 に対してマイグレーションを適用する。
  - **本番デプロイ時**: Cloudflare Workers の Git 連携設定で、デプロイコマンドの前にマイグレーションを実行するスクリプトを呼び出すか、または手動で `wrangler d1 migrations apply skill-quest-db-production --remote --env production` を実行してからデプロイする。
  - **プレビューデプロイ時**: 同様に `wrangler d1 migrations apply skill-quest-db-preview --remote --env preview` を実行してからデプロイする。
- **順序**: 1) マイグレーション適用、2) バックエンド（Workers）デプロイ、3) フロントエンド（Pages）デプロイ。フロントエンドはバックエンド API に依存するため、バックエンドを先に上げる。
- **注意**: Cloudflare Workers の Git 連携では、デプロイコマンドの前にマイグレーションを自動実行するには、デプロイコマンドを `pnpm exec wrangler d1 migrations apply skill-quest-db-production --remote --env production && npx wrangler deploy --env production` のように結合するか、または `package.json` にデプロイスクリプトを定義してそれを呼び出す。

## 4. Cloudflare Pages と Workers のデプロイ順序と依存関係

1. **D1 マイグレーション**（対象環境のリモート D1）
2. **Cloudflare Workers（backend）** のデプロイ（`wrangler deploy --env production` または `--env preview`）
3. **Cloudflare Pages（frontend）** のデプロイ（`pnpm build` 成果物のアップロード、または Git 連携の場合は push に連動）

- フロントエンドのビルド時に `VITE_API_URL` 等で参照する API のベース URL は、環境ごとに異なる値とする（本番用・プレビュー用）。Pages の環境変数で注入する。

## 5. ロールバック手順とリリース判定基準

- **リリース判定**: 「main にマージされ、Cloudflare の Git 連携による自動デプロイが成功し、Cloudflare 上で本番 Worker と Pages が更新完了した時点」を本番リリースとする。
- **ロールバック**:
  - **コードのロールバック**: main を前のコミットに戻してマージするか、前のコミットを指す新 PR をマージし、再度自動デプロイを走らせる。Cloudflare Dashboard の「デプロイ」タブから「前のデプロイ」に切り戻す運用も可能。
  - **マイグレーションのロールバック**: D1 は後方互換のないスキーマ変更を戻す場合、ダウンマイグレーション用 SQL を別途用意し、手動で `wrangler d1 execute` することを推奨。自動ロールバックは初版では対象外とする。

## 6. ブランチ戦略

- **develop ブランチ**: プレビュー環境への自動デプロイの対象。機能開発やバグ修正をこのブランチにマージして検証する。
- **main ブランチ**: 本番環境への自動デプロイの対象。develop で検証済みのコードをマージする。

## 7. 本ドキュメントの更新

- 新しい環境の追加やトリガー・順序を変更する際は、本戦略を更新し、Cloudflare Dashboard での Git 連携設定と整合させること。
