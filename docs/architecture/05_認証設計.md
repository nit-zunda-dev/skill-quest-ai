# 認証とアイデンティティ管理 (Better Auth)

Better Authは、NextAuth.js等の既存ソリューションと比較して、TypeScriptでの型安全性とバンドルサイズの小ささに優れ、特にCloudflare Workersのような環境での動作を第一級市民としてサポートしている。

## Cloudflare Workersへの統合

### 課題と解決策

Cloudflare Workersでは、ランタイム時にしか環境変数（`env.DB`など）にアクセスできない。Better Authの初期化時にDBアダプタを渡す必要があるため、静的な `auth.ts` の定義ではバインディングを取得できないという課題がある。

### 解決策: オンデマンド初期化パターン

リクエストごとに `initAuth` 関数を呼び出し、そのコンテキストからDBバインディングを注入するパターンを採用する。

```typescript
// backend/src/auth.ts
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { drizzle } from "drizzle-orm/d1";
import * as schema from "./db/schema";

// 環境変数の型定義
export const auth = (env: any) => {
  const db = drizzle(env.DB, { schema });
  return betterAuth({
    database: drizzleAdapter(db, {
      provider: "sqlite",
    }),
    secret: env.BETTER_AUTH_SECRET,
    socialProviders: {
      github: {
        clientId: env.GITHUB_CLIENT_ID,
        clientSecret: env.GITHUB_CLIENT_SECRET,
      },
    },
    // CORSと信頼済みオリジンの設定が必須
    trustedOrigins: ["http://localhost:5173"],
  });
};
```

### Honoでのハンドラ実装

```typescript
// backend/src/routes/auth.ts
import { Hono } from "hono";
import { auth } from "../auth";

const app = new Hono<{ Bindings: Bindings }>();

app.on(["POST", "GET"], "/*", (c) => {
  const betterAuth = auth(c.env);
  return betterAuth.handler(c.req.raw);
});
```

## パスワードハッシュ: Workers Free プラン対応

Better Auth はデフォルトで **scrypt** を使用するが、scrypt はメモリ集約型かつ CPU 集約型であり、Cloudflare Workers Free プランの **CPU 10ms 制限**を超過しやすい。

### 解決策: PBKDF2（Web Crypto API）への置き換え

`apps/backend/src/lib/password.ts` にカスタムハッシュ関数を実装し、Better Auth の `emailAndPassword.password` オプションで差し替えている。

- **アルゴリズム**: PBKDF2 + SHA-256（100,000 iterations）
- **実装**: Web Crypto API (`crypto.subtle`) を使用（Cloudflare Workers にネイティブ対応）
- **フォーマット**: `saltHex:hashHex`（16バイト salt + 256ビット derived key）
- **検証**: timing-safe comparison で比較

```typescript
// auth.ts での設定
emailAndPassword: {
  enabled: true,
  password: {
    hash: hashPassword,    // PBKDF2 ベース
    verify: verifyPassword, // timing-safe comparison
  },
},
```

> **注意**: scrypt から PBKDF2 に切り替えた後は、scrypt でハッシュ済みの既存パスワードは検証できなくなる。既存ユーザーがいる場合はマイグレーション戦略が必要。初期構築時に PBKDF2 を採用しているため、現時点では問題ない。

## セッション管理とセキュリティ

- **HttpOnly Cookie**: セッショントークンはJavaScriptからアクセス不可なHttpOnly Cookieに保存され、XSS攻撃のリスクを軽減する
- **CSRF対策**: Better AuthはデフォルトでCSRF対策を行うが、フロントエンド（別オリジン）からのアクセスを許可するために、Hono側で適切なCORSヘッダー（`Access-Control-Allow-Credentials: true` 等）を設定する必要がある
