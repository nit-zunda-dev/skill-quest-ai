# データベース内の情報を確認する方法

ローカル開発で使用している Cloudflare D1（SQLite）の中身を確認する手順です。

## 前提

- ローカルで一度でも `pnpm --filter @skill-quest/backend dev` を実行しており、ローカル D1 が作成されていること
- マイグレーション適用済み（`pnpm --filter @skill-quest/backend db:migrate:local`）であること

## 方法1: Wrangler で SQL を実行する（推奨）

`wrangler d1 execute` で任意の SQL を実行できます。**ローカル**の DB を対象にする場合は必ず `--local` を付けます。

### 実行例（ルートから）

```bash
pnpm --filter @skill-quest/backend exec wrangler d1 execute skill-quest-db --local --command "SELECT 1;"
```

### バックエンドディレクトリから実行する場合

```bash
cd apps/backend
pnpm exec wrangler d1 execute skill-quest-db --local --command "SELECT 1;"
```

## よく使う確認用クエリ

### テーブル一覧

```bash
pnpm --filter @skill-quest/backend exec wrangler d1 execute skill-quest-db --local --command "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;"
```

### 各テーブルの件数

```bash
pnpm --filter @skill-quest/backend exec wrangler d1 execute skill-quest-db --local --command "
SELECT 'user' AS tbl, COUNT(*) AS cnt FROM user
UNION ALL SELECT 'session', COUNT(*) FROM session
UNION ALL SELECT 'account', COUNT(*) FROM account
UNION ALL SELECT 'verification', COUNT(*) FROM verification
UNION ALL SELECT 'skills', COUNT(*) FROM skills
UNION ALL SELECT 'quests', COUNT(*) FROM quests
UNION ALL SELECT 'user_progress', COUNT(*) FROM user_progress
UNION ALL SELECT 'interaction_logs', COUNT(*) FROM interaction_logs
UNION ALL SELECT 'user_character_generated', COUNT(*) FROM user_character_generated
UNION ALL SELECT 'user_character_profile', COUNT(*) FROM user_character_profile
UNION ALL SELECT 'ai_daily_usage', COUNT(*) FROM ai_daily_usage;
"
```

### ユーザー一覧（サンプル）

```bash
pnpm --filter @skill-quest/backend exec wrangler d1 execute skill-quest-db --local --command "SELECT id, name, email, created_at FROM user LIMIT 10;"
```

### スキル・クエスト一覧

```bash
pnpm --filter @skill-quest/backend exec wrangler d1 execute skill-quest-db --local --command "SELECT * FROM skills;"
pnpm --filter @skill-quest/backend exec wrangler d1 execute skill-quest-db --local --command "SELECT id, skill_id, title, difficulty FROM quests LIMIT 10;"
```

### AI利用状況（日次）

```bash
pnpm --filter @skill-quest/backend exec wrangler d1 execute skill-quest-db --local --command "SELECT * FROM ai_daily_usage ORDER BY date_utc DESC LIMIT 10;"
```

## 方法2: SQL ファイルで実行する

複数行の SQL を書いておき、ファイルで実行できます。

1. 例として `apps/backend/scripts/inspect.sql` を作成する
2. 以下で実行する（バックエンドディレクトリで）:

```bash
cd apps/backend
pnpm exec wrangler d1 execute skill-quest-db --local --file=scripts/inspect.sql
```

## 方法3: バックエンドの npm スクリプトを使う（任意）

`apps/backend/package.json` に以下のスクリプトを追加してあります。

| スクリプト | 説明 |
|-----------|------|
| `pnpm --filter @skill-quest/backend db:tables` | テーブル一覧を表示 |
| `pnpm --filter @skill-quest/backend db:counts` | 各テーブルの件数を表示 |

ルートから実行する例:

```bash
pnpm --filter @skill-quest/backend db:tables
pnpm --filter @skill-quest/backend db:counts
```

## リモート（本番・プレビュー）の DB を確認する場合

- `--local` を**付けずに**実行すると、Wrangler の設定（`wrangler.toml` の `database_id`）で指定したリモートの D1 に対して実行されます。
- 本番データを変更するクエリは極力避け、読み取り専用の確認に留めてください。

```bash
# プレビュー環境の DB に対して実行する例（要: wrangler.toml の env.preview の database_id が実在すること）
pnpm --filter @skill-quest/backend exec wrangler d1 execute skill-quest-db --remote --command "SELECT name FROM sqlite_master WHERE type='table';"
```

## 参考

- [D1データベース作成手順](./02_d1_database_setup.md)
- [データベース設計](../architecture/04_データベース設計.md)
- [Cloudflare D1 - Wrangler コマンド](https://developers.cloudflare.com/d1/wrangler-commands/)
