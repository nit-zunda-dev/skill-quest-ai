# OWASP ZAP（DAST）セットアップ手順

本ドキュメントでは、Skill Quest AI プロジェクトに OWASP ZAP（Zed Attack Proxy）を導入し、DAST（Dynamic Application Security Testing）による動的セキュリティスキャンを実施する手順を説明します。

## 概要

OWASP ZAP は、動作中の Web アプリケーションに対して脆弱性を検出する DAST ツールです。本プロジェクトでは、ローカルで起動したアプリを ZAP Desktop でスキャンする用途で利用します。

既存の [Snyk](../setup/06_snyk_setup.md)（SAST/SCA）と併用することで、静的解析と動的解析の両方でセキュリティをカバーします。

## 前提条件

- [ZAP Desktop](https://www.zaproxy.org/download/) をインストールすること

## 1. ローカルでの実行（ZAP Desktop）

ローカルでは **ZAP Desktop** を使ってスキャンします。GUI でアラートの確認や手動探索がしやすく、リリース前や大きな変更後の確認に適しています。

### 1.1 ZAP Desktop のインストール

1. [ZAP のダウンロードページ](https://www.zaproxy.org/download/) にアクセスします。
2. 「ZAP Desktop」用のインストーラ（Windows / macOS / Linux 向け）をダウンロードし、インストールします。
3. インストール後、ZAP Desktop を起動します。初回起動時に永続セッションの保存先を聞かれた場合は、任意の場所を指定するかスキップしてかまいません。

### 1.2 アプリを起動する

スキャン対象の URL が必要です。ローカルでフロント・バックを起動します。

```bash
# ルートでフロント・バック両方を起動
pnpm dev
```

- フロントエンド: 既定で `http://localhost:3000`
- バックエンド（API）: 既定で `http://localhost:8787`

### 1.3 スキャンの実行

1. ZAP Desktop のホーム画面で **「Automated Scan」** を選びます。
2. **「URL to attack」** にスキャン対象の URL を入力します（例: `http://localhost:3000`）。
3. **「Attack」** をクリックしてスキャンを開始します。
4. スキャンが終わったら、下部の **「Alerts」** タブで検出された脆弱性を確認します。重大度（High / Medium / Low など）やルール ID で並べ替えできます。
5. 必要に応じて、メニュー **Report → Generate HTML Report** などからレポートをエクスポートできます。

### 1.4 手動探索（Manual Explore）

ログイン後の画面や特定の操作フローをスキャンしたい場合に、**手動探索** を使います。ZAP のプロキシ経由でブラウザを操作し、実際にアプリ内を遷移することで、その間のリクエストが ZAP の **サイトツリー** に記録されます。記録された URL に対して後から **Active Scan（能動的スキャン）** を実行し、脆弱性を検出します。

#### 1.4.1 手動探索の開始

1. ZAP Desktop のホーム画面で **「Manual Explore」** をクリックします。
2. **「URL to explore」** に探索開始 URL を入力します（例: `http://localhost:3000`）。
3. **「Launch Browser」** をクリックします。
4. ZAP がプロキシ経由のブラウザ（Firefox など）を起動します。ZAP の CA 証明書が未インストールの場合、ブラウザ起動後に警告が出ることがあります。その場合は ZAP メニュー **Tools → Options → Dynamic SSL Certificates** から証明書をエクスポートし、ブラウザにインストールしてください。

#### 1.4.2 アプリ内での操作

1. 起動したブラウザで、探索したい範囲を **手動で操作** します。例:
   - トップページ → 各リンクをクリック
   - ログイン画面 → ログイン実行
   - ログイン後のダッシュボード → 各種メニュー・フォーム遷移
   - API を呼ぶ操作（検索、投稿、編集など）
2. 操作するたびに、リクエストが ZAP の **Sites** タブ（左ペイン）のサイトツリーに追加されていきます。
3. スキャンしたい画面・API を一通りカバーするまで操作を続けます。漏れがないように、テストしたいフローを事前にチェックリスト化しておくと便利です。

#### 1.4.3 手動探索の終了

1. 探索が終わったらブラウザを閉じます（ZAP 側の「Launch Browser」で開いたブラウザを閉じる）。
2. ZAP の **Sites** タブで、記録されたノード（URL）を確認します。必要なノードが含まれているか確認してください。

### 1.5 手動探索後の攻撃（Active Scan）

手動探索で記録されたリクエストに対して、**Active Scan** を実行して能動的に脆弱性を検出します。

#### 1.5.1 スキャン対象の選択

1. ZAP 左ペインの **Sites** タブで、スキャンしたいノードを選びます。
   - **サイト単位**（例: `http://localhost:3000`）を右クリックして **「Attack → Active Scan」** で、そのサイト配下の全 URL を対象にできます。
   - **特定のノード** だけをスキャンしたい場合は、そのノードを右クリックして **「Attack → Active Scan」** を選択します。
   - **複数ノード** を対象にする場合は、Ctrl（macOS は Cmd）を押しながら複数選択し、右クリック → **「Attack → Active Scan」** でまとめてスキャンできます。
2. **Active Scan** ダイアログが開いたら、必要に応じてオプションを確認します。
   - **Attack Mode**: 通常は **Standard** のままで問題ありません。
   - **Recurse**: サブノードも含める場合はオンにします（サイトルートを選んだ場合はオン推奨）。

#### 1.5.2 スキャンの実行

1. **「Attack」** をクリックして Active Scan を開始します。
2. 下部の **「Active Scan」** タブで進捗を確認します。スキャン時間は対象 URL 数やルール数により数分〜数十分かかることがあります。
3. スキャン中は対象アプリ（`pnpm dev`）が起動していることを確認してください。アプリが落ちているとリクエストが失敗し、結果に影響します。
4. スキャン完了後、**「Alerts」** タブで検出されたアラートを確認します。

#### 1.5.3 アラートの確認とレポート出力

1. **Alerts** タブで、重大度（High / Medium / Low / Informational）やルール ID でフィルタ・ソートできます。
2. 各アラートをクリックすると、該当リクエストやレスポンス、推奨対応策が表示されます。
3. False Positive と判断したアラートは、右クリック → **「Delete」** または **False Positive としてマーク** で無視設定できます。
4. メニュー **Report → Generate HTML Report** からレポートをエクスポートし、`tests/reports/` などに保存できます。ファイル名に日付を含めると管理しやすくなります（例: `2026-02-14-ZAP-Report.html`）。

## 2. アラートの無視

アラートを右クリックして **「Delete」** または **「Alert → Delete」** で削除するか、**「False Positive」としてマーク**することで、同一ルールのアラートを無視できます。

## 3. ベストプラクティス

1. **スキャン対象**: ローカルで起動したアプリ（`pnpm dev` 後の `http://localhost:3000`）を対象にすると効果的です。
2. **頻度**: リリース前や大きな変更後に、ZAP Desktop で手動実行する運用を推奨します。
3. **アラートの優先度**: Critical / High を優先して対応し、False Positive は ZAP Desktop 上で False Positive としてマークするか理由を残しておきます。
4. **Snyk との役割分担**: Snyk はコード・依存関係の静的解析、ZAP は動作中のアプリの動的解析として併用します。

## 4. トラブルシューティング

### 「クラウドメタデータが露呈する可能性」のスキャンが非常に長い／終わらない

**現象**: Active Scan の「クラウドメタデータが露呈する可能性」（Alert ID 90034）が、経過時間だけ増えてリクエスト数が 0 のまま、または完了の気配がない。

**原因**: このルールは AWS / GCP / Azure のインスタンスメタデータ用 IP（`169.254.169.254`）へ、Host ヘッダーを悪用したリクエストを送り、誤設定の NGINX 経由でメタデータが漏れないか検査します。**localhost はクラウド VM ではない**ため、そのアドレスへの接続は応答せず、TCP のタイムアウト（数十秒〜長い場合それ以上）まで待つことになり、スキャンが極端に長く感じます。

**対処**（ローカル専用スキャンの場合）:

1. **ルールを無効化する（推奨）**  
   **Analyse → Scan Policy → Active Scan** を開き、一覧から「Cloud Metadata Potentially Exposed」を探してチェックを外し、ローカルスキャン時だけこのルールを無効にします。本番がクラウドで NGINX を使う場合は、本番向けスキャンでは再度有効にしてください。
2. **スキャンが終わるまで待つ**  
   タイムアウトまで待てばいずれ完了しますが、毎回時間がかかります。
3. **不要ならスキャンポリシーで除外**  
   上記 Scan Policy で「Technology」を指定し、使っていない技術のルールを減らすと、全体のスキャン時間短縮にもなります。

本番が AWS/GCP/Azure 上で NGINX を利用する場合は、このルールは有効のまま本番向けスキャンで実行することを推奨します。

### localhost に接続できない

- 先に `pnpm dev` でフロント・バックを起動し、ブラウザで `http://localhost:3000` が開けることを確認してください。
- ファイアウォールやセキュリティソフトで ZAP がブロックされていないか確認してください。

### 認証が必要な画面までスキャンしたい

- 上記の **1.4 手動探索** と **1.5 手動探索後の攻撃** の手順に従って、Manual Explore でログインなどの操作を行い、記録されたリクエストに対して Active Scan を実行してください。フォーム認証の自動化などは [ZAP 認証](https://www.zaproxy.org/docs/authentication/) を参照してください。

## 5. 参考リンク

- [OWASP ZAP 公式](https://www.zaproxy.org/)
- [ZAP Desktop ダウンロード](https://www.zaproxy.org/download/)
- [ZAP Desktop ユーザーガイド](https://www.zaproxy.org/docs/desktop/)
- [ZAP 認証](https://www.zaproxy.org/docs/authentication/)
