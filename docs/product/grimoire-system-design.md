# グリモワール（冒険の記録）システム設計

グリモワールのAI出力が「微妙」というフィードバックを踏まえ、**ナラティブは洗練されたテンプレート**とし、**タイトルと報酬だけをAIに出力させる**方式で設計するドキュメントです。ユーザーに作成方法を選ばせる選択肢はありません。

**関連**: [product.md 要約](../.kiro/steering/product.md) ／ 既存実装: `apps/backend/src/routes/grimoire.ts`, `apps/backend/src/services/ai.ts` (generateGrimoire)

---

## 1. 現状の整理

### 1.1 グリモワールの現在の役割

| 項目 | 内容 |
|------|------|
| **位置づけ** | 過去に生成された物語の履歴閲覧（冒険ログ） |
| **トリガー** | ユーザーが「グリモワール作成」ボタンを押す（1日1回まで） |
| **入力** | その時点で完了済みの**すべてのタスク**一覧 ＋ キャラプロフィール ＋ 直近3件の narrative |
| **出力** | 1エントリ = **章タイトル** ＋ **物語（narrative）** ＋ **報酬（XP / Gold）** |
| **AI** | 現状は章タイトル・narrative・報酬をまとめて生成。品質のばらつきが課題。 |

### 1.2 「微妙」と感じる要因の仮説

| 要因 | 説明 |
|------|------|
| **品質のばらつき** | 長文の物語をAIに書かせるため当たり外れが大きい。抽象的・陳腐な表現になりがち。 |
| **一括要約の無理** | 複数タスクを1つの物語にまとめるため、個々のタスクが薄まる。 |
| **章タイトルのずれ** | 実タスクと章タイトルのイメージが合わないことがある（タイトルは短文のためAIでも改善余地あり）。 |

---

## 2. ユーザー価値と採用方針

### 2.1 ユーザーが得たい価値

| 価値 | 説明 | 優先度 |
|------|------|--------|
| **振り返りのよろこび** | 自分がやったことが記録に残り、読み返して達成感を得る | 高 |
| **一貫性・自分ごと化** | タスク名・日付・難易度が確実に織り込まれ、自分事として読める | 高 |
| **成長の可視化** | XP/ゴールド・レベルと連動し「進んでる」実感を持てる | 中 |
| **章の印象** | その日の冒険を象徴するタイトルで、記憶が呼び覚まされる | 中 |

### 2.2 採用方針: ナラティブはテンプレート、タイトル・報酬はAI

- **ナラティブ（物語文）**: **洗練されたテンプレート**で生成する。タスク名・日付・種別・難易度・報酬を変数で埋め込み、文体と構成を統一する。AIは使わない。
- **章タイトル・報酬（XP/Gold）**: **AIに出力させる**。タスク一覧とキャラコンテキストから、章タイトルと報酬だけを返すAPIに変更する。
- **ユーザー操作**: 作成方法の選択はない。「グリモワール作成」ボタン1つで、上記の組み合わせが実行される。

これにより「確実に読みやすい物語」を保ちつつ、タイトルと報酬だけAIに任せることで負荷と当たり外れを抑える。

---

## 3. 仕様

### 3.1 全体フロー

1. ユーザーが「グリモワール作成」を押す（選択肢はなし）。
2. 日次制限（1日1回）をチェック。超過なら 429 を返す。
3. **完了タスク0件のとき**: AIは呼ばない。フォールバックでタイトル「物語の始まりを待つ」・報酬0・0件用テンプレートで narrative を組み立て、エントリを1件作成して 200 を返す。
4. **1件以上のとき** — **AI呼び出し**: 入力は従来どおり（完了タスク一覧・キャラプロフィール・直近の記録など）。**出力は章タイトル（title）と報酬（rewardXp, rewardGold）のみ**。narrative は要求しない。
5. **ナラティブ生成**（0件・1件以上ともテンプレート）: 完了タスク・キャラ名・日付・種別・難易度・**AIが返した報酬値**を使って、洗練されたテンプレートで narrative を組み立てる。
6. エントリを保存（title, narrative, rewardXp, rewardGold）。プロフィールを更新。200 で返す。
7. AI失敗・パース失敗時は、**タイトルと報酬をルールで決定**（後述）し、narrative は同じテンプレートで生成。エントリは必ず1件作成する。

### 3.2 ナラティブ（洗練されたテンプレート）

物語文は常にテンプレートで生成する。変数で埋めたあとも、一文ずつ読みやすく整える。

#### 入力

- 完了済みタスク一覧（title, type, difficulty, completedAt）
- キャラ名（プロフィールの name。なければ「冒険者」）
- 報酬合計（**AIが返した rewardXp / rewardGold**。フォールバック時は難易度ベースの合算）

#### 変数一覧

| 変数 | 説明 | 例 |
|------|------|-----|
| `date` | 採用した日付（ja-JP） | 2025/2/23 |
| `characterName` | キャラ名 | 冒険者 |
| `taskCount` | 完了タスク数 | 3 |
| `taskTitles` | タスク名のリスト（表示用） | 『英単語10語』『コードレビュー』… |
| `taskTitle` | 1件時のタスク名 | 英単語10語 |
| `taskTypeLabel` | 種別の表示ラベル | 日課 |
| `difficultyLabel` | 難易度の表示ラベル | 中 |
| `totalXp` | 合計XP（AI or フォールバック） | 75 |
| `totalGold` | 合計G（AI or フォールバック） | 43 |

- 種別ラベル: DAILY→日課, HABIT→習慣, TODO→討伐
- 難易度ラベル: EASY→易, MEDIUM→中, HARD→難
- タスク名が長い場合は先頭から一定文字数で切り「…」を付けてよい（例: 30文字）

#### 洗練されたテンプレート案（narrative）

**1件のとき**

- 「{date}、{characterName}はクエスト『{taskTitle}』（{taskTypeLabel}・{difficultyLabel}）を成し遂げた。+{totalXp} XP と {totalGold} G が、冒険の証として刻まれる。」

**2件以上のとき**

- 「{date}、{characterName}は{taskCount}つのクエストに挑み、すべてを征した。{taskTitles}。その軌跡に、+{totalXp} XP と {totalGold} G が記される。」

文言は製品トーンに合わせて調整する。ポイントは、**日付・キャラ名・タスク名・種別・難易度・報酬**を漏れなく入れつつ、一文を短く区切り、読み返したときの達成感が伝わること。

### 3.3 AI出力（タイトル・報酬のみ）

- **役割**: 章タイトル（title）と報酬（rewardXp, rewardGold）だけを返す。narrative は生成しない。
- **入力**: 現行と同様（完了タスク一覧、キャラ名・クラス・レベル・目標、直近の記録など、必要に応じて直近のタイトルのみでも可）。
- **出力形式**: JSON で `{ "title": "...", "rewardXp": number, "rewardGold": number }` のみ。プロンプトから narrative の指示を削除し、トークン消費と当たり外れを減らす。
- **制限**: 1日1回（`ai_daily_usage.grimoire_count`）。超過時は 429。

#### フォールバック（AI失敗・パース失敗時）

- **title**: ルールで生成。  
  - 1件: 「{日付} — 『{タスク名}』を征す」  
  - 2件以上: 「{日付}の冒険 — {件数}クエスト制覇」
- **rewardXp / rewardGold**: 難易度ベースの合算（EASY 15/8, MEDIUM 30/18, HARD 60/35）。
- フォールバック後も **narrative は同じ洗練テンプレート** で組み立て、エントリを1件作成する。

### 3.4 API

- **エンドポイント**: `POST /api/grimoire/generate`（body なしでよい。作成方法の切り替えはない）。
- **処理**: 上記 3.1 のフロー。AIはタイトル・報酬のみ取得。narrative は常にテンプレート。
- **レスポンス**: 現行と同じ（`grimoireEntry`, `profile`, `oldProfile`）。

### 3.5 UI

- **作成入口**: 「グリモワール作成」ボタンのみ。作成方法の選択は表示しない。
- **生成中**: ボタン押下後、AI呼び出し中は「生成中…」などを表示。
- **残り回数**: 「本日あと○回」など、1日1回制限の説明は任意で表示してよい。

### 3.6 文言例（ナラティブ）

**1件**

- `2025/2/23、冒険者はクエスト『英単語10語』（日課・中）を成し遂げた。+30 XP と 18 G が、冒険の証として刻まれる。`

**複数**

- `2025/2/23、冒険者は3つのクエストに挑み、すべてを征した。『英単語10語』『コードレビュー』『ランニング5km』。その軌跡に、+75 XP と 43 G が記される。`

**フォールバック時のタイトル例**

- 1件: `2025/2/23 — 『英単語10語』を征す`
- 複数: `2025/2/23の冒険 — 3クエスト制覇`

---

## 4. 次のステップ

1. **テンプレート確定**: 3.2 の narrative 文言を製品トーンで確定する。
2. **AIプロンプト変更**: `generateGrimoire` を「title + rewardXp + rewardGold のみ返す」ように変更。narrative の指示とパースを削除。
3. **ナラティブ生成の実装**: テンプレート＋変数展開をバックエンドに実装。AIが返した報酬値をテンプレートに渡す。
4. **フォールバック**: AI失敗時はタイトル・報酬をルールで算出し、同じテンプレートで narrative を組み立ててエントリ作成。
5. **UI**: 選択肢を削除し、「グリモワール作成」1ボタンのみにする（既存のままでも可）。生成中表示を維持。
6. **計測**: グリモワール作成率・閲覧率を確認する。

---

_本文書は「ナラティブ＝テンプレート、タイトル・報酬＝AI」の前提です。確定仕様は要件・設計フェーズで更新してください。_
